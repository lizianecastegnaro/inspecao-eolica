<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0000FF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Inspe√ß√µes">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Inspe√ß√µes Eletromec√¢nicas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0000FF 0%, #0066FF 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0000FF 0%, #0066FF 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 20px;
            color: #0000FF;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .required {
            color: #e74c3c;
        }

        input[type="text"],
        input[type="month"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            box-sizing: border-box;
            -webkit-appearance: none;
            appearance: none;
            background-color: white;
        }

        input[type="date"] {
            min-height: 48px;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #0000FF;
            box-shadow: 0 0 0 3px rgba(0, 0, 255, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .tree-nav {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .tree-item {
            margin: 5px 0;
        }

        .tree-category {
            font-weight: bold;
            color: #0000FF;
            cursor: pointer;
            padding: 10px;
            border-radius: 5px;
            transition: background 0.2s;
        }

        .tree-category:hover {
            background: #e6e6ff;
        }

        .tree-subcategory {
            margin-left: 20px;
            color: #555;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
        }

        .tree-subcategory:hover {
            background: #f0f0f0;
        }

        .tree-component {
            margin-left: 40px;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }

        .tree-component:hover {
            background: #fff;
            border-left-color: #0000FF;
        }

        .tree-component.active {
            background: #0000FF;
            color: white;
            border-left-color: #0066FF;
        }

        .inspection-form {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .photo-upload {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .photo-upload:hover {
            border-color: #0000FF;
            background: #f0f0ff;
        }

        .photo-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .photo-item {
            position: relative;
            width: 150px;
            height: 150px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0000FF 0%, #0066FF 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 255, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .progress-info {
            background: #e6e6ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0000FF 0%, #0066FF 100%);
            transition: width 0.3s;
        }

        .buttons-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        /* Notifica√ß√£o Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-weight: 600;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }
        
        .toast.hide {
            animation: slideOut 0.3s ease-out forwards;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* Modal de Diagn√≥stico */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: linear-gradient(135deg, #0000FF 0%, #0066FF 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Cards de diagn√≥stico */
        .diag-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .diag-card h3 {
            margin: 0 0 15px 0;
            color: #0000FF;
            font-size: 16px;
        }

        .diag-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .diag-stat {
            text-align: center;
        }

        .diag-stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #0000FF;
        }

        .diag-stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .diag-alert {
            padding: 12px 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
        }

        .diag-alert.success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }

        .diag-alert.warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }

        .diag-alert.error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }

        .diag-alert.info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }

        .diag-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-top: 10px;
        }

        .diag-table th,
        .diag-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .diag-table th {
            background: #e9ecef;
            font-weight: 600;
        }

        .diag-table tr:hover {
            background: #f5f5f5;
        }

        /* Fotos no diagn√≥stico */
        .diag-photos-container {
            margin-top: 20px;
        }

        .diag-photo-group {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .diag-photo-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .diag-photo-title {
            font-size: 13px;
            color: #333;
            margin-bottom: 10px;
        }

        .diag-photo-count {
            color: #666;
            font-weight: normal;
        }

        .diag-photo-thumbs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .diag-thumb {
            width: 80px;
            height: 80px;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .diag-thumb:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
        }

        .diag-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Modal de foto ampliada */
        .photo-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .photo-modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .photo-modal-content img {
            max-width: 100%;
            max-height: 85vh;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .photo-modal-close {
            position: absolute;
            top: -15px;
            right: -15px;
            background: white;
            border: none;
            color: #333;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .photo-modal-close:hover {
            background: #f0f0f0;
        }

        @media (max-width: 768px) {
            .content {
                padding: 15px;
            }

            .buttons-row {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                margin-right: 0;
            }

            .modal-content {
                max-height: 95vh;
            }

            .diag-stats {
                gap: 15px;
            }

            .diag-stat-value {
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
    <!-- Modal de Diagn√≥stico -->
    <div id="diagnosticModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîç Diagn√≥stico do Sistema</h2>
                <button class="modal-close" onclick="closeDiagnosticModal()">&times;</button>
            </div>
            <div class="modal-body" id="diagnosticContent">
                <!-- Conte√∫do ser√° preenchido via JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeDiagnosticModal()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Foto Ampliada -->
    <div id="photoModal" class="photo-modal-overlay" style="display: none;" onclick="closePhotoModal()">
        <div class="photo-modal-content" onclick="event.stopPropagation()">
            <button class="photo-modal-close" onclick="closePhotoModal()">&times;</button>
            <img id="photoModalImg" src="" alt="Foto ampliada">
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üå¨Ô∏è Inspe√ß√µes Eletromec√¢nicas dos Parques E√≥licos</h1>
            <p id="parqueNome"><strong>Parque E√≥lico Coxilha Negra</strong></p>
            <div style="margin-top: 15px; background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px;">
                <p id="progressoParque" style="margin: 0 0 8px 0; font-size: 14px; opacity: 0.95;">
                    üìä Aerogeradores completos: <strong>0/72</strong> (0%)
                </p>
                <div style="height: 6px; background: rgba(255,255,255,0.3); border-radius: 10px; overflow: hidden;">
                    <div id="progressoParqueBarra" style="height: 100%; background: #4CAF50; width: 0%; transition: width 0.5s;"></div>
                </div>
            </div>
        </div>

        <div class="content">
            <!-- Informa√ß√µes Gerais -->
            <div class="section">
                <h2 class="section-title">üìã Informa√ß√µes Gerais</h2>
                
                <div class="form-group">
                    <label>Parque E√≥lico <span class="required">*</span></label>
                    <select id="parque" required>
                        <option value="coxilha_negra" selected>Parque E√≥lico Coxilha Negra</option>
                        <option value="entorno_2" disabled style="color:#999;">Parque E√≥lico Entorno 2 (em breve)</option>
                        <option value="cerro_chato" disabled style="color:#999;">Parque E√≥lico Cerro Chato (em breve)</option>
                        <option value="ibirapuita" disabled style="color:#999;">Parque E√≥lico Ibirapuit√£ (em breve)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Aerogerador <span class="required">*</span></label>
                    <select id="aerogerador" required>
                        <option value="">Selecione o aerogerador...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Data da Inspe√ß√£o <span class="required">*</span></label>
                    <input type="date" id="mesAno" required>
                </div>
            </div>

            <!-- Progresso -->
            <div class="progress-info">
                <strong>Progresso da Inspe√ß√£o:</strong> <span id="progressText">0 de 105 componentes</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>

            <!-- Navega√ß√£o em √Årvore -->
            <div class="section">
                <h2 class="section-title">üå≥ Selecione o Componente</h2>
                <div class="tree-nav" id="treeNav"></div>
            </div>

            <!-- Formul√°rio de Inspe√ß√£o -->
            <div class="section" id="inspectionSection" style="display: none;">
                <h2 class="section-title">‚úèÔ∏è Inspe√ß√£o do Componente</h2>
                
                <div class="inspection-form">
                    <h3 id="componentTitle" style="margin-bottom: 20px; color: #0000FF;"></h3>

                    <div class="form-group">
                        <label>Classifica√ß√£o <span class="required">*</span></label>
                        <select id="classificacao" required>
                            <option value="">Selecione...</option>
                            <option value="Verificado">Verificado</option>
                            <option value="Defeito Ligeiro">Defeito Ligeiro</option>
                            <option value="Defeito Grave">Defeito Grave </option>
                            <option value="A√ß√£o Imediata">A√ß√£o Imediata</option>
                        </select>
                    </div>

                    <div class="form-group" id="falhaGroup" style="display: none;">
                        <label>Falha <span class="required">*</span></label>
                        <select id="falha" required>
                            <option value="">Selecione a falha...</option>
                        </select>
                    </div>

                    <div class="form-group" id="falhaOutraGroup" style="display: none;">
                        <label>Descreva a falha <span class="required">*</span></label>
                        <input type="text" id="falhaOutra" placeholder="Digite a falha encontrada...">
                    </div>

                    <div class="form-group">
                        <label>Observa√ß√µes (opcional)</label>
                        <textarea id="observacoes" placeholder="Digite observa√ß√µes adicionais..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Fotos (opcional)</label>
                        <div class="photo-upload" id="photoUpload">
                            <p>üì∏ Clique ou arraste fotos aqui</p>
                            <input type="file" id="photoInput" accept="image/*" multiple style="display: none;">
                        </div>
                        <div class="photo-preview" id="photoPreview"></div>
                    </div>

                    <div class="buttons-row">
                        <button class="btn btn-primary" id="saveComponent">üíæ Salvar Componente</button>
                        <button class="btn btn-secondary" id="clearForm">üóëÔ∏è Limpar Formul√°rio</button>
                    </div>
                </div>
            </div>

            <!-- Bot√µes de A√ß√£o -->
            <div class="section">
                <div class="buttons-row">
                    <button class="btn btn-success" id="exportData">üìä Exportar para Excel/CSV</button>
                    <button class="btn btn-success" id="exportAll">üìä Exportar TODAS as Inspe√ß√µes</button>
                    <button class="btn btn-secondary" id="viewData">üìÑ Ver Relat√≥rio</button>
                    <button class="btn btn-info" id="exportHTML">üì§ Exportar Relat√≥rio HTML</button>
                    <button class="btn btn-secondary" id="diagData" title="Verificar integridade dos dados salvos">üîç Diagn√≥stico</button>
                </div>
                <div class="buttons-row" style="margin-top: 10px;">
                    <button class="btn btn-primary" id="backupData" title="Salvar todos os dados em um arquivo">üíæ Fazer Backup</button>
                    <button class="btn btn-secondary" id="restoreData" title="Restaurar dados de um arquivo de backup">üìÇ Restaurar Backup</button>
                    <input type="file" id="restoreFileInput" accept=".json" style="display: none;">
                </div>
            </div>
        </div>
    </div>

    <script>
// Dados da estrutura de inspe√ß√£o
const ESTRUTURA = {
  "classificacoes": [
    "Verificado",
    "Defeito Ligeiro",
    "Defeito Grave",
    "A√ß√£o Imediata"
  ],
  "categorias": {
    "Exterior e Acessos": {
      "Funda√ß√£o": {
        "Funda√ß√£o": {
          "classificacoes": [],
          "falhas": [
            "Dano no acabamento do grout",
            "Contamina√ß√£o por √≥leo"
          ]
        }
      },
      "Aterramento e SPDA": {
        "Tampas de inspe√ß√£o": {
          "classificacoes": [],
          "falhas": [
            "Oxida√ß√£o",
            "Tampa ausente",
            "Tampa Danificada",
            "Aterramento n√£o localizado",
            "Aterramento danificado"
          ]
        }
      },
      "Carenagem": {
        "PAD": {
          "classificacoes": [],
          "falhas": [
            "Obst√°culos no acesso",
            "Vegeta√ß√£o em excesso"
          ]
        },
        "Escada externa": {
          "classificacoes": [],
          "falhas": [
            "Oxida√ß√£o",
            "Contamina√ß√£o por √≥leo",
            "Defeito estrutural",
            "Presen√ßa de animais"
          ]
        },
        "Porta lado externo": {
          "classificacoes": [],
          "falhas": [
            "Oxida√ß√£o",
            "Veda√ß√£o danificada",
            "Danos estruturais"
          ]
        },
        "Porta lado interno": {
          "classificacoes": [],
          "falhas": [
            "Oxida√ß√£o",
            "Veda√ß√£o danificada",
            "Danos estruturais"
          ]
        }
      },
      "Sa√∫de e seguran√ßa": {
        "Identifica√ß√£o da turbina": {
          "classificacoes": [],
          "falhas": [
            "Identifica√ß√£o ausente",
            "Identifica√ß√£o danificada"
          ]
        }
      },
      "Torre  exterior": {
        "Tramos": {
          "classificacoes": [],
          "falhas": [
            "Eros√£o acentuada",
            "Trincas no concreto",
            "Presen√ßa animais"
          ]
        },
        "Pintura": {
          "classificacoes": [],
          "falhas": [
            "Ac√∫mulo de sujeira",
            "Contamina√ß√£o por √≥leo"
          ]
        }
      },
      "Vias de acesso": {
        "Vias de acesso": {
          "classificacoes": [],
          "falhas": [
            "Obst√°culos no acesso",
            "Vegeta√ß√£o em excesso"
          ]
        }
      }
    },
    "Torre do Aerogerador": {
      "Carenagem": {
        "Interior - Plataforma": {
          "classificacoes": [],
          "falhas": [
            "Ac√∫mulo de Sujeira",
            "Ac√∫mmulo de √°gua",
            "Presen√ßa de animais"
          ]
        },
        "Aterramento da torre": {
          "classificacoes": [],
          "falhas": [
            "Oxida√ß√£o",
            "Danos por arco el√©trico",
            "Aus√™ncia de isolamento",
            "Conex√£o danificada"
          ]
        }
      },
      "Torre interior": {
        "Tramos": {
          "classificacoes": [],
          "falhas": [
            "Trincas no concreto",
            "Dano na estrutura",
            "Infiltra√ß√£o de √°gua"
          ]
        }
      },
      "Sa√∫de e seguran√ßa": {
        "Ilumina√ß√£o da base": {
          "classificacoes": [],
          "falhas": [
            "Fora de opera√ß√£o"
          ]
        },
        "Ilumina√ß√£o de emerg√™ncia": {
          "classificacoes": [],
          "falhas": [
            "Fora de opera√ß√£o"
          ]
        },
        "Degraus da escada": {
          "classificacoes": [],
          "falhas": [
            "Aus√™ncia de certifica√ß√£o",
            "Danos estruturais",
            "Fixa√ß√£o danificada"
          ]
        },
        "Parafusos de fixa√ß√£o da escada": {
          "classificacoes": [],
          "falhas": [
            "Oxida√ß√£o",
            "Folgas nas conex√µes",
            "Marca√ß√µes alteradas"
          ]
        },
        "Linha de vida": {
          "classificacoes": [],
          "falhas": [
            "Fixa√ß√£o inadequada",
            "Aus√™ncia de certifica√ß√£o",
            "Oxida√ß√£o",
            "Danos estruturais",
            "Validade da ceritifica√ß√£o expirada"
          ]
        }
      },
      "Elevador de servi√ßo": {
        "Certifica√ß√£o": {
          "classificacoes": [],
          "falhas": [
            "Aus√™ncia de certifica√ß√£o",
            "Validade da inspe√ß√£o inspirada"
          ]
        },
        "Manuten√ß√£o": {
          "classificacoes": [],
          "falhas": [
            "Aus√™ncia de livro de registro",
            "Manuten√ß√£o atrasada"
          ]
        },
        "Parapeito": {
          "classificacoes": [],
          "falhas": [
            "Danos estruturais",
            "Fixa√ß√£o inadequada",
            "Oxida√ß√£o"
          ]
        },
        "Painel el√©trico": {
          "classificacoes": [],
          "falhas": [
            "Danos estruturais",
            "Fixa√ß√£o inadequada",
            "Oxida√ß√£o",
            "Painel el√©trico violado"
          ]
        },
        "Teste funcional": {
          "classificacoes": [],
          "falhas": [
            "Elevador bloqueado",
            "Danos estruturais",
            "Cabos danificados",
            "Mecanismo danificado",
            "Elevador inoperante",
            "Ac√∫mulo de sujeira",
            "Ac√∫mulo de materiais"
          ]
        }
      },
      "Aterramentos": {
        "Conex√µes na base": {
          "classificacoes": [],
          "falhas": [
            "Aterramento ausente",
            "Aterramento danificado",
            "Aterramento solto",
            "Oxida√ß√£o"
          ]
        }
      }
    },
    "Subsolo": {
      "Estado geral": {
        "Limpeza": {
          "classificacoes": [],
          "falhas": [
            "Ac√∫mulo de sujeira",
            "Ac√∫mulo de √°gua",
            "Presen√ßa de animais"
          ]
        },
        "Ilumina√ß√£o": {
          "classificacoes": [],
          "falhas": [
            "Fora de opera√ß√£o"
          ]
        }
      }
    },
    "Sistema el√©trico / Gabinetes": {
      "Sistema el√©trico/Ventila√ß√£o": {
        "N√∫mero de s√©rie da UPS": {
          "classificacoes": [],
          "falhas": [
            "Identifica√ß√£o ausente",
            "Identifica√ß√£o danificada"
          ]
        },
        "Testar UPS": {
          "classificacoes": [],
          "falhas": [
            "UPS inoperante"
          ]
        },
        "Tomadas auxiliares/tomadas da torre": {
          "classificacoes": [],
          "falhas": [
            "Tomada inoperante",
            "Falha na isola√ß√£o",
            "Fixa√ß√£o inadequada",
            "Sinais de aquecimento"
          ]
        },
        "Cabos de pot√™ncia": {
          "classificacoes": [],
          "falhas": [
            "Desgaste por atrito",
            "Oxida√ß√£o nas fixa√ß√µes",
            "Instala√ß√£o inadequada"
          ]
        },
        "Sistema de ventila√ß√£o": {
          "classificacoes": [],
          "falhas": [
            "Ac√∫mulo de sujeira",
            "Filtro de ar ausente",
            "Filtro de ar danificado",
            "Danos estruturais",
            "Sistema inoperante"
          ]
        }
      },
      "Cub√≠culo de Sa√≠da": {
        "Condi√ß√µes externas do Swichgear": {
          "classificacoes": [],
          "falhas": [
            "Ac√∫mulo de sujeira",
            "Aus√™ncia da TAG"
          ]
        },
        "Carca√ßa": {
          "classificacoes": [],
          "falhas": [
            "Oxida√ß√£o",
            "Aus√™ncia de aterramento",
            "Danos na pintura"
          ]
        },
        "Veda√ß√µes do Switchgear": {
          "classificacoes": [],
          "falhas": [
            "Aterramento ausente",
            "Danos estruturais"
          ]
        },
        "Chave de comuta√ß√£o": {
          "classificacoes": [],
          "falhas": [
            "Chave ausente",
            "Chave fora de padr√£o"
          ]
        },
        "Indicadores de posi√ß√£o": {
          "classificacoes": [],
          "falhas": [
            "Parafuso ausente",
            "Swichgear inoperante"
          ]
        }
      },
      "Cubiculo de Sa√≠da": {
        "Press√£o de g√°s do Swichgear": {
          "classificacoes": [],
          "falhas": [
            "Press√£o de g√°s baixa",
            "Aus√™ncia de press√£o"
          ]
        }
      }
    },
    "Torre Se√ß√£o do Yaw Loop": {
      "Cabos do Loop": {
        "Circuitos potencia/controle/comunica√ß√£o": {
          "classificacoes": [],
          "falhas": [
            "Sinais de aquecimento",
            "Sinais de arco el√©trico",
            "cabos desconectados",
            "Cabos torcidos",
            "Danos estruturais",
            "Cabos rompidos"
          ]
        },
        "Sensor de tor√ß√£o dos cabos": {
          "classificacoes": [],
          "falhas": [
            "Fora de opera√ß√£o",
            "Fixa√ß√£o inadequada",
            "Fim de curso com Falha"
          ]
        },
        "Tomadas auxiliares/tomadas da torre": {
          "classificacoes": [],
          "falhas": [
            "Fora de opera√ß√£o",
            "Fixa√ß√£o inadequada",
            "Sinais de arco el√©trico"
          ]
        },
        "Instala√ß√£o dos cabos": {
          "classificacoes": [],
          "falhas": [
            "Cabos cruzados",
            "Danos estruturais",
            "Danos nas guias de fixa√ß√£o"
          ]
        },
        "Plataforma do elevador/loop": {
          "classificacoes": [],
          "falhas": [
            "Danos estruturais",
            "Fixa√ß√£o inadequada"
          ]
        }
      },
      "Sistema do Yaw": {
        "Lubrifica√ß√£o": {
          "classificacoes": [],
          "falhas": [
            "Lubrifica√ß√£o insuficiente",
            "Excesso de graxa",
            "Graxa contaminada",
            "Graxa degradada",
            "Ponto de lubrifica√ß√£o obstru√≠do",
            "Sistema de Lubrifica√ß√£o autom√°tica ausente"
          ]
        },
        "Sensor de poci√ß√£o da nacele": {
          "classificacoes": [],
          "falhas": [
            "Sensor inoperante",
            "Fixa√ß√£o inadequada",
            "Sensor n√£o identificado",
            "Sensor danificado"
          ]
        },
        "Dentes e pinh√µes do yaw": {
          "classificacoes": [],
          "falhas": [
            "Desgaste excessivo",
            "Dano mec√¢nico",
            "Lubrifica√ß√£o insuficiente",
            "Desalinhamento"
          ]
        },
        "Rolamento do yaw": {
          "classificacoes": [],
          "falhas": [
            "Oxida√ß√£o",
            "Veda√ß√£o danificada",
            "Folga excessiva",
            "Dano mec√¢nico"
          ]
        },
        "Parafusos nacelle-torre": {
          "classificacoes": [],
          "falhas": [
            "Marcas de torque desalinhadas",
            "Oxida√ß√£o",
            "Parafuso ausente",
            "Parafuso danificado",
            "Fixa√ß√£o frouxa"
          ]
        }
      },
      "Motor-Redutor Yaw": {
        "Registrar placa de identifica√ß√£o": {
          "classificacoes": [],
          "falhas": [
            "Placa ausente",
            "Placa danificada"
          ]
        },
        "N√≠vel de √≥leo dos motores redutores": {
          "classificacoes": [],
          "falhas": [
            "N√≠vel de √≥leo baixo",
            "Carca√ßa danificada",
            "Oxida√ß√£o"
          ]
        },
        "Pinhoes e cremalheira": {
          "classificacoes": [],
          "falhas": [
            "Desgaste excessivo",
            "Dano mec√¢nico",
            "Lubrifica√ß√£o insuficiente",
            "Desalinhamento"
          ]
        },
        "Acionamento para os dois lados": {
          "classificacoes": [],
          "falhas": [
            "Ru√≠dos anormais",
            "Dano mec√¢nico",
            "N√£o aciona em um sentido",
            "N√£o aciona em ambos sentidos"
          ]
        }
      },
      "Sa√∫de e seguran√ßa": {
        "Ilumina√ß√£o": {
          "classificacoes": [],
          "falhas": [
            "Fora de opera√ß√£o"
          ]
        },
        "Ilumina√ß√£o de emergencia": {
          "classificacoes": [],
          "falhas": [
            "Fora de opera√ß√£o"
          ]
        },
        "Pontos de ancoragem": {
          "classificacoes": [],
          "falhas": [
            "Fixa√ß√£o inadequada",
            "Trinca",
            "Oxida√ß√£o",
            "Dano estrutural"
          ]
        },
        "Escada de acesso a Nacelle": {
          "classificacoes": [],
          "falhas": [
            "Fixa√ß√£o inadequada",
            "Trinca",
            "Oxida√ß√£o",
            "Dano estrutural",
            "Degrau danificado"
          ]
        },
        "Plataforma do Yaw e parapeitos": {
          "classificacoes": [],
          "falhas": [
            "Danos estruturais",
            "Fixa√ß√£o inadequada"
          ]
        }
      }
    },
    "Drive train": {
      "Drive train": {
        "Conex√£o do Hub - Main Carrier": {
          "classificacoes": [],
          "falhas": [
            "Oxida√ß√£o",
            "Dano mec√¢nico",
            "Desgaste excessivo",
            "Marcas de torque desalinhadas",
            "Folga entre o flange da tampa e alojamento",
            "Fixa√ß√£o inadequada"
          ]
        },
        "Eixo principal": {
          "classificacoes": [],
          "falhas": [
            "Dano mec√¢nico",
            "Oxida√ß√£o",
            "Pintura danificada",
            "Vazamento",
            "Marca de torque desalinhada",
            "Parafuso danificado",
            "Parafuso frouxo",
            "Desalinhamento",
            "Desnivelamento",
            "Parafuso ausente"
          ]
        },
        "Rolamento principal": {
          "classificacoes": [],
          "falhas": [
            "Vazamento de graxa",
            "Veda√ß√£o danificada",
            "Lubrifica√ß√£o insuficiente",
            "Excesso de graxa",
            "Graxa contaminada",
            "Coletor de graxa sujo"
          ]
        },
        "Rolamento frontal": {
          "classificacoes": [],
          "falhas": [
            "Vazamento de graxa",
            "Veda√ß√£o danificada",
            "Lubrifica√ß√£o insuficiente",
            "Excesso de graxa",
            "Graxa contaminada",
            "Coletor de graxa sujo"
          ]
        }
      },
      "Sistema hidr√°ulico/Freio": {
        "Sistema hidr√°ulico": {
          "classificacoes": [],
          "falhas": [
            "Vazamento de √≥leo",
            "Filtro dessecante saturado",
            "Press√£o baixa",
            "V√°lvula com falha",
            "Sensor com falha",
            "√ìleo contaminado",
            "Mangueira danificada",
            "Vazamento de √≥leo",
            "√ìleo degradado"
          ]
        },
        "Idle, stop/reset e emergency stop": {
          "classificacoes": [],
          "falhas": [
            "Acionamento parcial",
            "Resposta lenta",
            "Falha de comando",
            "Emergency stop n√£o atia",
            "Ru√≠do anormal"
          ]
        },
        "Funcionamento mec√¢nico do freio": {
          "classificacoes": [],
          "falhas": [
            "Freio inoperante",
            "Acionamento parcial",
            "Resposta lenta",
            "Falha de comando",
            "Ru√≠do anormal",
            "Falha no emergency stop"
          ]
        },
        "Funcionamento do Rotor Lock": {
          "classificacoes": [],
          "falhas": [
            "nificado",
            "Pino trava ausente",
            "Bra√ßo danificado",
            "Fixa√ß√£o inadequada",
            "Mangueiras desconctadas"
          ]
        }
      }
    },
    "Gerador": {
      "Estado geral": {
        "Carca√ßa": {
          "classificacoes": [],
          "falhas": [
            "Identifica√ß√£o ausente",
            "Identifica√ß√£o ileg√≠vel",
            "Dano mec√¢nico",
            "Trinca",
            "Oxida√ß√£o",
            "Contamina√ß√£o por √≥leo",
            "Deforma√ß√£o"
          ]
        },
        "Escudo do estator": {
          "classificacoes": [],
          "falhas": [
            "Enrolamento danificado",
            "P√≥lo danificado",
            "Bucin danificado",
            "Fixa√ß√£o inadequada",
            "Isolamento danificado",
            "Oxida√ß√£o",
            "Sinal de aquecimento",
            "Sinal de arco el√©trico"
          ]
        },
        "Rotor": {
          "classificacoes": [],
          "falhas": [
            "Enrolamento danificado",
            "P√≥lo danificado",
            "Bucin danificado",
            "Fixa√ß√£o inadequada",
            "Isolamento danificado",
            "Oxida√ß√£o",
            "Sinal de aquecimento",
            "Sinal de arco el√©trico"
          ]
        },
        "Retificador/conversor": {
          "classificacoes": [],
          "falhas": [
            "Cabo solto",
            "Cabo danificado",
            "Sinal de arco el√©trico",
            "Sinal de aquecimento",
            "Prote√ß√£o acr√≠lica danificada",
            "Prote√ß√£o acr√≠lica ausente",
            "Entrada de ar obstru√≠da",
            "Componente frouxo",
            "Filtro sujo",
            "Filtro danificado"
          ]
        },
        "Filtro do gerador": {
          "classificacoes": [],
          "falhas": [
            "Filtro sujo",
            "Filtro obstru√≠do",
            "Filtro danificado",
            "Filtro ausente",
            "Fixa√ß√£o inadequada",
            "Elemento de fixa√ß√£o frouxo",
            "Entrada de ar obstru√≠da",
            "Veda√ß√£o danificada"
          ]
        }
      }
    },
    "Conversor/Pain√©is": {
      "Retificadores e Conversores": {
        "Pain√©is U01": {
          "classificacoes": [],
          "falhas": [
            "Fechadura danificada",
            "Cabos rompidos",
            "Cabos sem isola√ß√£o",
            "Disjuntor desarmado"
          ]
        },
        "Pain√©is U02": {
          "classificacoes": [],
          "falhas": [
            "Fechadura danificada",
            "Cabos rompidos",
            "Cabos sem isola√ß√£o",
            "Disjuntor desarmado"
          ]
        },
        "Pain√©is U48": {
          "classificacoes": [],
          "falhas": [
            "Fechadura danificada",
            "Cabos rompidos",
            "Cabos sem isola√ß√£o",
            "Disjuntor desarmado"
          ]
        },
        "Pain√©is U20": {
          "classificacoes": [],
          "falhas": [
            "Fechadura danificada",
            "Cabos rompidos",
            "Cabos sem isola√ß√£o",
            "Disjuntor desarmado"
          ]
        },
        "Pain√©is U50": {
          "classificacoes": [],
          "falhas": [
            "Fechadura danificada",
            "Cabos rompidos",
            "Cabos sem isola√ß√£o",
            "Disjuntor desarmado"
          ]
        },
        "Pain√©is U06": {
          "classificacoes": [],
          "falhas": [
            "Fechadura danificada",
            "Cabos rompidos",
            "Cabos sem isola√ß√£o",
            "Disjuntor desarmado"
          ]
        },
        "Conex√µes gabinetes/cabos de fibra √≥ptica": {
          "classificacoes": [],
          "falhas": [
            "Cabos desconectados",
            "Cabos rompidos"
          ]
        },
        "Prote√ß√£o contra interrup√ß√£o de corrente": {
          "classificacoes": [],
          "falhas": [
            "Disjuntor desarmado"
          ]
        },
        "Cabos de pot√™ncia": {
          "classificacoes": [],
          "falhas": [
            "Cabos desconectados",
            "Cabos rompidos"
          ]
        },
        "DPS": {
          "classificacoes": [],
          "falhas": [
            "Sinal de descarga atmosf√©rica"
          ]
        }
      }
    },
    "Nacelle Interior": {
      "Estado geral": {
        "Carenagem de a√ßo": {
          "classificacoes": [],
          "falhas": [
            "Pintura danificada",
            "Dano mec√¢nico",
            "Oxida√ß√£o",
            "Fixa√ß√£o inadequada",
            "Elemento de fixa√ß√£o frouxo",
            "Marca de torque desalinhada",
            "Selante danificado",
            "Selante ausente",
            "Escotilha com falha de funcionamento",
            "Entrada de ar obstru√≠da"
          ]
        },
        "Estruturas de suporte": {
          "classificacoes": [],
          "falhas": [
            "Oxida√ß√£o",
            "Trinca",
            "Marca de impacto",
            "Solda danificada",
            "Fixa√ß√£o inadequada",
            "Elemento de fixa√ß√£o frouxo",
            "Marca de torque desalinhada",
            "Dano mec√¢nico"
          ]
        },
        "Escotilha de evacua√ß√£o da nacelle": {
          "classificacoes": [],
          "falhas": [
            "Oxida√ß√£o",
            "Solda danificada",
            "Marca de torque desalinhada",
            "Trava com falha",
            "Trava danificada",
            "Fixa√ß√£o inadequada",
            "Elemento de fixa√ß√£o frouxo",
            "Mobilidade comprometida",
            "N√£o opera",
            "Funcionamento irregular",
            "Dano mec√¢nico"
          ]
        },
        "Guincho/Talha": {
          "classificacoes": [],
          "falhas": [
            "Funcionamento irregular",
            "Corrente danificada",
            "Corrente desgastada",
            "Corrente com corros√£o",
            "Gancho danificado",
            "Trava do gancho com falha",
            "Vazamento na talha",
            "Bacia de conten√ß√£o danificada",
            "Bacia de conten√ß√£o ausente"
          ]
        }
      },
      "El√©trico": {
        "Painel de controle da nacelle": {
          "classificacoes": [],
          "falhas": [
            "Cabo solto",
            "Cabo danificado",
            "Componente frouxo",
            "Entrada de ar obstru√≠da",
            "Filtro sujo",
            "Filtro danificado",
            "Filtro ausente",
            "Sinal de aquecimento",
            "Sinal de arco el√©trico"
          ]
        },
        "Arm√°rio de controle das luzes de navega√ß√£o": {
          "classificacoes": [],
          "falhas": [
            "Cabo solto",
            "Cabo danificado",
            "Fixa√ß√£o inadequada",
            "Entrada de ar obstru√≠da",
            "Filtro sujo",
            "Filtro danificado",
            "Filtro ausente",
            "Sinal de aquecimento",
            "Sinal de arco el√©trico"
          ]
        },
        "Inversor de Yaw": {
          "classificacoes": [],
          "falhas": [
            "Cabo solto",
            "Cabo danificado",
            "Fixa√ß√£o inadequada",
            "Entrada de ar obstru√≠da",
            "Filtro sujo",
            "Filtro danificado",
            "Filtro ausente",
            "Sinal de aquecimento",
            "Sinal de arco el√©trico"
          ]
        },
        "Cabos e fios": {
          "classificacoes": [],
          "falhas": [
            "Cabo danificado",
            "Isolamento danificado",
            "Cabo solto",
            "Fixa√ß√£o inadequada",
            "Roteamento inadequado",
            "Tor√ß√£o excessiva",
            "Cabo prensado",
            "Guia de cabo danificada",
            "Guia de cabo ausente"
          ]
        },
        "UPS": {
          "classificacoes": [],
          "falhas": [
            "UPS inoperante",
            "Autonomia insuficiente",
            "Bateria degradada",
            "Bateria danificada",
            "Alarme ativo",
            "Falha no autoteste",
            "Dano mec√¢nico",
            "Fixa√ß√£o inadequada",
            "Indicador de falha ativo"
          ]
        }
      },
      "Sa√∫de e seguran√ßa": {
        "Sinaliza√ß√µes de advert√™ncia": {
          "classificacoes": [],
          "falhas": [
            "Placa ausente",
            "Placa danificada"
          ]
        },
        "Ilumina√ß√£o e ilumina√ß√£o de emergencia": {
          "classificacoes": [],
          "falhas": [
            "Fora de opera√ß√£o"
          ]
        },
        "Tomadas auxiliares/tomadas da nacelle": {
          "classificacoes": [],
          "falhas": [
            "Fora de opera√ß√£o",
            "Fixa√ß√£o inadequada",
            "Sinais de arco el√©trico"
          ]
        },
        "Teste funcional Parada de emerg√™ncia": {
          "classificacoes": [],
          "falhas": [
            "Fora de opera√ß√£o"
          ]
        },
        "Kit resgate": {
          "classificacoes": [],
          "falhas": [
            "Aus√™ncia de certifica√ß√£o"
          ]
        },
        "Extintores de inc√™ndio": {
          "classificacoes": [],
          "falhas": [
            "Carga baixa",
            "Extintor descarregado",
            "Validade vencida",
            "Lacre violado",
            "Man√¥metro fora da faixa",
            "Extintor danificado",
            "Suporte de fixa√ß√£o danificado"
          ]
        }
      }
    },
    "Nacelle Exterior": {
      "Estado geral": {
        "Carenagem exterior": {
          "classificacoes": [],
          "falhas": [
            "Pintura danificada",
            "Dano mec√¢nico",
            "Oxida√ß√£o",
            "Fixa√ß√£o inadequada",
            "Elemento de fixa√ß√£o frouxo",
            "Marca de torque desalinhada",
            "Selante danificado",
            "Selante ausente",
            "Escotilha com falha de funcionamento",
            "Entrada de ar obstru√≠da"
          ]
        },
        "Escotilha de acesso e manobra": {
          "classificacoes": [],
          "falhas": [
            "Oxida√ß√£o",
            "Solda danificada",
            "Marca de torque desalinhada",
            "Trava com falha",
            "Trava danificada",
            "Fixa√ß√£o inadequada",
            "Elemento de fixa√ß√£o frouxo",
            "Mobilidade comprometida",
            "N√£o opera",
            "Funcionamento irregular",
            "Dano mec√¢nico"
          ]
        },
        "Sensores meterol√≥gicos": {
          "classificacoes": [],
          "falhas": [
            "Dano mec√¢nico",
            "Veda√ß√£o danificada",
            "Fixa√ß√£o inadequada",
            "Sinal de descarga el√©trica",
            "Revestimento fissurado",
            "Prote√ß√£o da cavidade danificada",
            "Sensor inoperante",
            "Leitura inst√°vel"
          ]
        }
      },
      "Sa√∫de e seguran√ßa": {
        "Luzes de avia√ß√£o": {
          "classificacoes": [],
          "falhas": [
            "Fora de opera√ß√£o",
            "Aus√™ncia da luz de avia√ß√£o"
          ]
        },
        "Pontos de ancoragem": {
          "classificacoes": [],
          "falhas": [
            "Fixa√ß√£o inadequada",
            "Trinca",
            "Oxida√ß√£o",
            "Dano estrutural"
          ]
        }
      },
      "Aterramento e SPDA": {
        "Para-raios e suporte de fixa√ß√£o": {
          "classificacoes": [],
          "falhas": [
            "Para-raios danificado",
            "Oxida√ß√£o",
            "Sinal de descarga el√©trica",
            "Suporte de fixa√ß√£o danificado",
            "Suporte de fixa√ß√£o ausente",
            "Conex√£o solta"
          ]
        },
        "Conex√£o ao SPDA": {
          "classificacoes": [],
          "falhas": [
            "Conex√£o ausente",
            "Conex√£o solta",
            "Conex√£o el√©trica danificada",
            "Oxida√ß√£o",
            "Corros√£o",
            "Sinal de descarga el√©trica",
            "Fixa√ß√£o inadequada"
          ]
        }
      },
      "Sistema de Arrefecimento": {
        "Radiadores externos": {
          "classificacoes": [],
          "falhas": [
            "Oxida√ß√£o",
            "Vazamentos"
          ]
        },
        "Eletro-ventilador": {
          "classificacoes": [],
          "falhas": [
            "Oxida√ß√£o",
            "Vazamentos"
          ]
        },
        "Mangueiras e Conex√µes": {
          "classificacoes": [],
          "falhas": [
            "Oxida√ß√£o",
            "Vazamentos"
          ]
        },
        "Estrutura de fixa√ß√£o": {
          "classificacoes": [],
          "falhas": [
            "Danos estruturais",
            "Aus√™ncia de parafuso",
            "Oxida√ß√£o",
            "Pintura danificada"
          ]
        }
      }
    }
  }
};

// Lista de aerogeradores
const AEROGERADORES = [
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-01"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-02"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-03"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-04"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-05"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-06"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-07"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-08"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-09"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-10"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-11"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-12"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-13"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-14"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-15"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-16"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-17"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-18"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-19"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-20"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-21"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-22"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-23"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 2",
    "codigo": "ECN2-24"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-01"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-02"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-03"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-04"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-05"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-06"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-07"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-08"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-09"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-10"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-11"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-12"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-13"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-14"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-15"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-16"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-17"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-18"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-19"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-20"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-21"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-22"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-23"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-24"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 3",
    "codigo": "ECN3-25"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-01"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-02"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-03"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-04"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-05"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-06"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-07"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-08"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-09"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-10"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-11"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-12"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-13"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-14"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-15"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-16"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-17"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-18"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-19"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-20"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-21"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-22"
  },
  {
    "parque": "Coxilha Negra",
    "sub_parque": "Coxilha Negra 4",
    "codigo": "ECN4-23"
  }
];

        // Estado da aplica√ß√£o
        let currentComponent = null;
        let currentPhotos = [];
        let inspectionData = {};
        let totalComponentes = 0;
        let db = null; // Refer√™ncia ao IndexedDB

        // ========== SISTEMA DE ARMAZENAMENTO IndexedDB ==========
        const DB_NAME = 'InspecaoEolicaDB';
        const DB_VERSION = 1;
        const STORE_INSPECTIONS = 'inspections';
        const STORE_PHOTOS = 'photos';

        /**
         * Inicializa o IndexedDB
         */
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    console.error('Erro ao abrir IndexedDB:', event.target.error);
                    reject(event.target.error);
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('IndexedDB aberto com sucesso');
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    console.log('Criando/atualizando estrutura do IndexedDB...');
                    const database = event.target.result;

                    // Store para inspe√ß√µes
                    if (!database.objectStoreNames.contains(STORE_INSPECTIONS)) {
                        const inspStore = database.createObjectStore(STORE_INSPECTIONS, { keyPath: 'key' });
                        inspStore.createIndex('aerogerador', 'aerogerador', { unique: false });
                        inspStore.createIndex('categoria', 'categoria', { unique: false });
                    }

                    // Store para fotos
                    if (!database.objectStoreNames.contains(STORE_PHOTOS)) {
                        database.createObjectStore(STORE_PHOTOS, { keyPath: 'key' });
                    }
                };
            });
        }

        /**
         * Salva uma inspe√ß√£o no IndexedDB
         */
        function saveInspectionToDB(key, data) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('DB n√£o inicializado'));
                    return;
                }
                const transaction = db.transaction([STORE_INSPECTIONS], 'readwrite');
                const store = transaction.objectStore(STORE_INSPECTIONS);
                const request = store.put({ key, ...data });

                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
         * Carrega todas as inspe√ß√µes do IndexedDB
         */
        function loadAllInspectionsFromDB() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('DB n√£o inicializado'));
                    return;
                }
                const transaction = db.transaction([STORE_INSPECTIONS], 'readonly');
                const store = transaction.objectStore(STORE_INSPECTIONS);
                const request = store.getAll();

                request.onsuccess = (event) => {
                    const results = event.target.result;
                    const data = {};
                    results.forEach(item => {
                        const key = item.key;
                        delete item.key;
                        data[key] = item;
                    });
                    resolve(data);
                };
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
         * Salva fotos no IndexedDB
         */
        function savePhotosToDB(key, photos) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('DB n√£o inicializado'));
                    return;
                }
                const transaction = db.transaction([STORE_PHOTOS], 'readwrite');
                const store = transaction.objectStore(STORE_PHOTOS);
                
                if (photos && photos.length > 0) {
                    const request = store.put({ key, photos });
                    request.onsuccess = () => resolve();
                    request.onerror = (e) => reject(e.target.error);
                } else {
                    const request = store.delete(key);
                    request.onsuccess = () => resolve();
                    request.onerror = (e) => reject(e.target.error);
                }
            });
        }

        /**
         * Carrega fotos do IndexedDB
         */
        function loadPhotosFromDB(key) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('DB n√£o inicializado'));
                    return;
                }
                const transaction = db.transaction([STORE_PHOTOS], 'readonly');
                const store = transaction.objectStore(STORE_PHOTOS);
                const request = store.get(key);

                request.onsuccess = (event) => {
                    const result = event.target.result;
                    resolve(result ? result.photos : []);
                };
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
         * Carrega todas as fotos do IndexedDB
         */
        function loadAllPhotosFromDB() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('DB n√£o inicializado'));
                    return;
                }
                const transaction = db.transaction([STORE_PHOTOS], 'readonly');
                const store = transaction.objectStore(STORE_PHOTOS);
                const request = store.getAll();

                request.onsuccess = (event) => {
                    const results = event.target.result;
                    const data = {};
                    results.forEach(item => {
                        data[item.key] = item.photos;
                    });
                    resolve(data);
                };
                request.onerror = (e) => reject(e.target.error);
            });
        }

        /**
         * Limpa todos os dados do IndexedDB
         */
        function clearAllDB() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('DB n√£o inicializado'));
                    return;
                }
                const transaction = db.transaction([STORE_INSPECTIONS, STORE_PHOTOS], 'readwrite');
                
                transaction.objectStore(STORE_INSPECTIONS).clear();
                transaction.objectStore(STORE_PHOTOS).clear();

                transaction.oncomplete = () => resolve();
                transaction.onerror = (e) => reject(e.target.error);
            });
        }

        /**
         * Obt√©m estat√≠sticas de armazenamento
         */
        async function getStorageStats() {
            if (navigator.storage && navigator.storage.estimate) {
                const estimate = await navigator.storage.estimate();
                return {
                    usage: estimate.usage,
                    quota: estimate.quota,
                    usageFormatted: formatBytes(estimate.usage),
                    quotaFormatted: formatBytes(estimate.quota),
                    percentUsed: ((estimate.usage / estimate.quota) * 100).toFixed(2) + '%'
                };
            }
            return null;
        }

        // Inicializar
        async function init() {
            console.log('=== INICIANDO APLICA√á√ÉO PWA ===');
            console.log('Timestamp:', new Date().toISOString());
            
            try {
                // Registrar Service Worker para funcionar offline
                if ('serviceWorker' in navigator) {
                    try {
                        const registration = await navigator.serviceWorker.register('./service-worker.js');
                        console.log('Service Worker registrado:', registration.scope);
                    } catch (swError) {
                        console.warn('Service Worker n√£o registrado:', swError);
                    }
                }

                console.log('1. Inicializando banco de dados...');
                await initDB();
                
                console.log('2. Contando componentes...');
                countTotalComponents();
                
                console.log('3. Carregando aerogeradores...');
                loadAerogeradores();
                
                console.log('4. Construindo √°rvore...');
                buildTree();
                
                console.log('5. Configurando event listeners...');
                setupEventListeners();
                
                console.log('6. Carregando dados salvos...');
                await loadSavedData();
                
                console.log('7. Definindo m√™s padr√£o...');
                setDefaultMonth();
                
                console.log('8. Atualizando progresso do parque...');
                updateParqueProgress();
                
                // Mostrar estat√≠sticas de armazenamento
                const stats = await getStorageStats();
                if (stats) {
                    console.log(`Armazenamento: ${stats.usageFormatted} de ${stats.quotaFormatted} (${stats.percentUsed})`);
                }
                
                console.log('=== APLICA√á√ÉO PWA INICIADA COM SUCESSO ===');
            } catch (error) {
                console.error('ERRO AO INICIAR:', error);
                alert('Erro ao iniciar aplica√ß√£o: ' + error.message);
            }
        }

        function setDefaultMonth() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            document.getElementById('mesAno').value = `${year}-${month}-${day}`;
        }

        function loadAerogeradores() {
            const select = document.getElementById('aerogerador');
            AEROGERADORES.forEach(aero => {
                const option = document.createElement('option');
                option.value = aero.codigo;
                option.textContent = `${aero.codigo} - ${aero.sub_parque}`;
                
                // Verificar se este aerogerador est√° 100% completo
                const progresso = getAerogeradorProgress(aero.codigo);
                if (progresso.percentual === 100) {
                    option.textContent = `‚úÖ ${aero.codigo} - ${aero.sub_parque} (Completo)`;
                    option.style.color = '#28a745';
                    option.style.fontWeight = 'bold';
                }
                
                select.appendChild(option);
            });
        }
        
        function getAerogeradorProgress(aerogerador) {
            const completed = Object.keys(inspectionData).filter(key => {
                return key.startsWith(aerogerador + '_');
            }).length;
            
            const percentual = totalComponentes > 0 ? (completed / totalComponentes) * 100 : 0;
            
            return {
                completed,
                total: totalComponentes,
                percentual: Math.round(percentual)
            };
        }

        function countTotalComponents() {
            let count = 0;
            const categorias = ESTRUTURA.categorias;
            for (const subcategorias of Object.values(categorias)) {
                for (const componentes of Object.values(subcategorias)) {
                    count += Object.keys(componentes).length;
                }
            }
            totalComponentes = count;
        }

        function updateComponentIcon(categoria, subcategoria, componente) {
            // Atualizar apenas o √≠cone do componente espec√≠fico
            document.querySelectorAll('.tree-component').forEach(comp => {
                const text = comp.textContent;
                if (text.includes(componente)) {
                    const status = getComponentStatus(categoria, subcategoria, componente);
                    const icon = status ? '‚úÖ' : '‚≠ï';
                    // Preservar apenas o nome do componente, trocar o √≠cone
                    comp.textContent = `${icon} ${componente}`;
                }
            });
        }
        
        function updateTreeCounters() {
            // Atualizar contadores nas categorias e subcategorias sem reconstruir
            const aero = document.getElementById('aerogerador').value;
            if (!aero) return;
            
            document.querySelectorAll('.tree-category').forEach(catEl => {
                const catText = catEl.textContent;
                // Extrair nome da categoria (remover √≠cone e contador)
                const catMatch = catText.match(/[üìÅ‚úÖ]\s+(.+?)(?:\s+\(\d+\/\d+\))?$/);
                if (!catMatch) return;
                
                const categoria = catMatch[1];
                const subcategorias = ESTRUTURA.categorias[categoria];
                if (!subcategorias) return;
                
                let totalCat = 0;
                let completosCat = 0;
                
                for (const [subcat, componentes] of Object.entries(subcategorias)) {
                    totalCat += Object.keys(componentes).length;
                    for (const comp of Object.keys(componentes)) {
                        if (getComponentStatus(categoria, subcat, comp)) {
                            completosCat++;
                        }
                    }
                }
                
                const catIcon = completosCat === totalCat && totalCat > 0 ? '‚úÖ' : 'üìÅ';
                catEl.textContent = `${catIcon} ${categoria} (${completosCat}/${totalCat})`;
            });
            
            // Atualizar subcategorias
            document.querySelectorAll('.tree-subcategory').forEach(subEl => {
                const subText = subEl.textContent;
                const subMatch = subText.match(/[‚îî‚îÄ‚úÖ]\s+(.+?)(?:\s+\(\d+\/\d+\))?$/);
                if (!subMatch) return;
                
                const subcategoria = subMatch[1];
                
                // Encontrar categoria pai
                let categoria = null;
                for (const [cat, subcats] of Object.entries(ESTRUTURA.categorias)) {
                    if (subcats[subcategoria]) {
                        categoria = cat;
                        break;
                    }
                }
                
                if (!categoria) return;
                
                const componentes = ESTRUTURA.categorias[categoria][subcategoria];
                const totalSub = Object.keys(componentes).length;
                let completosSub = 0;
                
                for (const comp of Object.keys(componentes)) {
                    if (getComponentStatus(categoria, subcategoria, comp)) {
                        completosSub++;
                    }
                }
                
                const subIcon = completosSub === totalSub && totalSub > 0 ? '‚úÖ' : '‚îî‚îÄ';
                subEl.textContent = `${subIcon} ${subcategoria} (${completosSub}/${totalSub})`;
            });
        }
        
        function buildTree() {
            const treeNav = document.getElementById('treeNav');
            const categorias = ESTRUTURA.categorias;
            const aero = document.getElementById('aerogerador').value;

            // Salvar estado atual da √°rvore (quais est√£o abertos)
            const openCategories = new Set();
            const openSubcategories = new Set();
            
            treeNav.querySelectorAll('.tree-category').forEach(cat => {
                const container = cat.nextElementSibling;
                if (container && container.style.display !== 'none') {
                    openCategories.add(cat.textContent);
                }
            });
            
            treeNav.querySelectorAll('.tree-subcategory').forEach(sub => {
                const container = sub.nextElementSibling;
                if (container && container.style.display !== 'none') {
                    openSubcategories.add(sub.textContent);
                }
            });

            treeNav.innerHTML = '';

            for (const [categoria, subcategorias] of Object.entries(categorias)) {
                const catDiv = document.createElement('div');
                catDiv.className = 'tree-item';
                
                // Contar total e completos na categoria
                let totalCat = 0;
                let completosCat = 0;
                for (const componentes of Object.values(subcategorias)) {
                    totalCat += Object.keys(componentes).length;
                    for (const [comp] of Object.entries(componentes)) {
                        if (aero && inspectionData[`${aero}_${categoria}_${Object.keys(subcategorias).find(sk => componentes === subcategorias[sk])}_${comp}`]) {
                            completosCat++;
                        }
                    }
                }
                
                const catTitle = document.createElement('div');
                catTitle.className = 'tree-category';
                const catIcon = completosCat === totalCat && totalCat > 0 ? '‚úÖ' : 'üìÅ';
                const catProgress = totalCat > 0 ? ` (${completosCat}/${totalCat})` : '';
                catTitle.textContent = `${catIcon} ${categoria}${catProgress}`;
                catDiv.appendChild(catTitle);

                const subContainer = document.createElement('div');
                const catKey = `üìÅ ${categoria}${catProgress}`;
                subContainer.style.display = openCategories.has(catKey) || openCategories.size === 0 ? 'block' : 'none';

                for (const [subcategoria, componentes] of Object.entries(subcategorias)) {
                    // Contar total e completos na subcategoria
                    const totalSub = Object.keys(componentes).length;
                    let completosSub = 0;
                    for (const [comp] of Object.entries(componentes)) {
                        if (aero && inspectionData[`${aero}_${categoria}_${subcategoria}_${comp}`]) {
                            completosSub++;
                        }
                    }
                    
                    const subDiv = document.createElement('div');
                    subDiv.className = 'tree-subcategory';
                    const subIcon = completosSub === totalSub && totalSub > 0 ? '‚úÖ' : '‚îî‚îÄ';
                    const subProgress = ` (${completosSub}/${totalSub})`;
                    subDiv.textContent = `${subIcon} ${subcategoria}${subProgress}`;
                    subContainer.appendChild(subDiv);

                    const compContainer = document.createElement('div');
                    const subKey = `‚îî‚îÄ ${subcategoria}${subProgress}`;
                    compContainer.style.display = openSubcategories.has(subKey) || openSubcategories.size === 0 ? 'block' : 'none';

                    for (const [componente, dados] of Object.entries(componentes)) {
                        const compDiv = document.createElement('div');
                        compDiv.className = 'tree-component';
                        
                        const status = getComponentStatus(categoria, subcategoria, componente);
                        const icon = status ? '‚úÖ' : '‚≠ï';
                        compDiv.textContent = `${icon} ${componente}`;
                        
                        compDiv.onclick = () => selectComponent(categoria, subcategoria, componente, dados);
                        compContainer.appendChild(compDiv);
                    }

                    subDiv.onclick = (e) => {
                        e.stopPropagation();
                        compContainer.style.display = compContainer.style.display === 'none' ? 'block' : 'none';
                    };

                    subContainer.appendChild(compContainer);
                }

                catTitle.onclick = () => {
                    subContainer.style.display = subContainer.style.display === 'none' ? 'block' : 'none';
                };

                catDiv.appendChild(subContainer);
                treeNav.appendChild(catDiv);
            }
        }

        function getComponentStatus(categoria, subcategoria, componente) {
            const aero = document.getElementById('aerogerador').value;
            if (!aero) return false;
            
            const key = `${aero}_${categoria}_${subcategoria}_${componente}`;
            return inspectionData[key] !== undefined;
        }

        function selectComponent(categoria, subcategoria, componente, dados) {
            currentComponent = {categoria, subcategoria, componente, dados};
            
            // Atualizar UI
            document.querySelectorAll('.tree-component').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');

            // Mostrar formul√°rio
            document.getElementById('inspectionSection').style.display = 'block';
            document.getElementById('componentTitle').textContent = 
                `${categoria} > ${subcategoria} > ${componente}`;

            // Carregar dados salvos se existirem
            loadComponentData();
            
            // Scroll suave
            document.getElementById('inspectionSection').scrollIntoView({behavior: 'smooth'});
        }

        function loadComponentData() {
            const aero = document.getElementById('aerogerador').value;
            if (!aero || !currentComponent) return;

            const key = `${aero}_${currentComponent.categoria}_${currentComponent.subcategoria}_${currentComponent.componente}`;
            const saved = inspectionData[key];

            if (saved) {
                document.getElementById('classificacao').value = saved.classificacao || '';
                document.getElementById('observacoes').value = saved.observacoes || '';
                updateFalhaDropdown();
                if (saved.falha) {
                    // Verificar se √© uma falha personalizada (n√£o est√° na lista)
                    const falhaSelect = document.getElementById('falha');
                    const opcaoExiste = Array.from(falhaSelect.options).some(opt => opt.value === saved.falha);
                    
                    if (opcaoExiste) {
                        falhaSelect.value = saved.falha;
                    } else if (saved.falha) {
                        // √â uma falha personalizada
                        falhaSelect.value = '__outra__';
                        document.getElementById('falhaOutra').value = saved.falha;
                        document.getElementById('falhaOutraGroup').style.display = 'block';
                    }
                }
                loadPhotos(key);
            } else {
                clearForm();
            }
        }

        function updateFalhaDropdown() {
            const classificacao = document.getElementById('classificacao').value;
            const falhaGroup = document.getElementById('falhaGroup');
            const falhaSelect = document.getElementById('falha');
            const falhaOutraGroup = document.getElementById('falhaOutraGroup');

            if (classificacao === 'Verificado' || !classificacao) {
                falhaGroup.style.display = 'none';
                falhaOutraGroup.style.display = 'none';
                falhaSelect.required = false;
            } else {
                falhaGroup.style.display = 'block';
                falhaSelect.required = true;

                // Preencher op√ß√µes de falha
                falhaSelect.innerHTML = '<option value="">Selecione a falha...</option>';
                
                if (currentComponent && currentComponent.dados && currentComponent.dados.falhas) {
                    const falhas = currentComponent.dados.falhas;
                    
                    falhas.forEach(falha => {
                        const option = document.createElement('option');
                        option.value = falha;
                        option.textContent = falha;
                        falhaSelect.appendChild(option);
                    });
                }
                
                // Adicionar op√ß√£o "Outra falha..."
                const optionOutra = document.createElement('option');
                optionOutra.value = '__outra__';
                optionOutra.textContent = '‚ûï Outra falha...';
                optionOutra.style.fontStyle = 'italic';
                falhaSelect.appendChild(optionOutra);
            }
            
            // Esconder campo de falha personalizada
            falhaOutraGroup.style.display = 'none';
        }
        
        function handleFalhaChange() {
            const falhaSelect = document.getElementById('falha');
            const falhaOutraGroup = document.getElementById('falhaOutraGroup');
            const falhaOutraInput = document.getElementById('falhaOutra');
            
            if (falhaSelect.value === '__outra__') {
                falhaOutraGroup.style.display = 'block';
                falhaOutraInput.required = true;
                falhaOutraInput.focus();
            } else {
                falhaOutraGroup.style.display = 'none';
                falhaOutraInput.required = false;
                falhaOutraInput.value = '';
            }
        }

        function setupEventListeners() {
            console.log('=== setupEventListeners iniciando ===');
            
            const saveBtn = document.getElementById('saveComponent');
            const clearBtn = document.getElementById('clearForm');
            const exportBtn = document.getElementById('exportData');
            const exportAllBtn = document.getElementById('exportAll');
            const viewBtn = document.getElementById('viewData');
            const diagBtn = document.getElementById('diagData');
            const exportHTMLBtn = document.getElementById('exportHTML');
            
            console.log('Bot√µes encontrados:', {
                saveBtn: !!saveBtn,
                clearBtn: !!clearBtn,
                exportBtn: !!exportBtn,
                exportAllBtn: !!exportAllBtn,
                viewBtn: !!viewBtn,
                diagBtn: !!diagBtn,
                exportHTMLBtn: !!exportHTMLBtn
            });
            
            // Atualizar t√≠tulo quando parque muda
            document.getElementById('parque').addEventListener('change', function() {
                const parqueSelect = this;
                const parqueNome = parqueSelect.options[parqueSelect.selectedIndex].text;
                document.getElementById('parqueNome').innerHTML = `<strong>${parqueNome}</strong>`;
            });
            
            document.getElementById('classificacao').addEventListener('change', updateFalhaDropdown);
            
            document.getElementById('falha').addEventListener('change', handleFalhaChange);
            
            document.getElementById('photoUpload').addEventListener('click', () => {
                document.getElementById('photoInput').click();
            });

            document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);

            if (saveBtn) {
                saveBtn.addEventListener('click', () => {
                    console.log('Bot√£o SALVAR clicado!');
                    saveComponentData();
                });
            }
            
            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    console.log('Bot√£o LIMPAR clicado!');
                    clearForm();
                });
            }
            
            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    console.log('Bot√£o EXPORTAR clicado!');
                    exportData();
                });
            }
            
            if (exportAllBtn) {
                exportAllBtn.addEventListener('click', () => {
                    console.log('Bot√£o EXPORTAR TODAS clicado!');
                    exportAllData();
                });
            }
            
            if (viewBtn) {
                viewBtn.addEventListener('click', () => {
                    console.log('Bot√£o VER DADOS clicado!');
                    viewSavedData();
                });
            }
            
            if (diagBtn) {
                diagBtn.addEventListener('click', () => {
                    console.log('Bot√£o DIAGN√ìSTICO clicado!');
                    runDiagnostics();
                });
            }
            
            if (exportHTMLBtn) {
                exportHTMLBtn.addEventListener('click', () => {
                    console.log('Bot√£o EXPORTAR HTML clicado!');
                    exportReportHTML();
                });
            }

            const backupBtn = document.getElementById('backupData');
            const restoreBtn = document.getElementById('restoreData');
            const restoreFileInput = document.getElementById('restoreFileInput');

            if (backupBtn) {
                backupBtn.addEventListener('click', () => {
                    console.log('Bot√£o BACKUP clicado!');
                    createBackup();
                });
            }

            if (restoreBtn) {
                restoreBtn.addEventListener('click', () => {
                    console.log('Bot√£o RESTAURAR clicado!');
                    restoreFileInput.click();
                });
            }

            if (restoreFileInput) {
                restoreFileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        restoreBackup(e.target.files[0]);
                        e.target.value = ''; // Limpar para permitir selecionar o mesmo arquivo novamente
                    }
                });
            }

            document.getElementById('aerogerador').addEventListener('change', () => {
                buildTree();
                updateProgress();
            });
            
            console.log('=== setupEventListeners conclu√≠do ===');
        }

        function handlePhotoUpload(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (file.size > 5 * 1024 * 1024) {
                    alert(`A foto ${file.name} √© muito grande. M√°ximo 5MB por foto.`);
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentPhotos.push(e.target.result);
                    displayPhotos();
                };
                reader.readAsDataURL(file);
            });
        }

        function displayPhotos() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';
            
            currentPhotos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'photo-item';
                
                const img = document.createElement('img');
                img.src = photo;
                
                const btn = document.createElement('button');
                btn.className = 'photo-remove';
                btn.textContent = '√ó';
                btn.onclick = () => {
                    currentPhotos.splice(index, 1);
                    displayPhotos();
                };
                
                div.appendChild(img);
                div.appendChild(btn);
                preview.appendChild(div);
            });
        }

        async function loadPhotos(key) {
            try {
                // Tentar carregar do IndexedDB primeiro
                let photos = await loadPhotosFromDB(`photos_${key}`);
                
                // Se n√£o encontrou no IndexedDB, tentar localStorage (migra√ß√£o)
                if ((!photos || photos.length === 0)) {
                    const lsKey = `photos_${key}`;
                    const lsPhotos = localStorage.getItem(lsKey);
                    if (lsPhotos) {
                        photos = JSON.parse(lsPhotos);
                        // Migrar para IndexedDB
                        await savePhotosToDB(lsKey, photos);
                    }
                }
                
                // Validar fotos
                if (photos && Array.isArray(photos)) {
                    currentPhotos = photos.filter(photo => {
                        if (typeof photo !== 'string') return false;
                        return photo.startsWith('data:image/') && photo.includes('base64,');
                    });
                } else {
                    currentPhotos = [];
                }
                
                displayPhotos();
            } catch (e) {
                console.error('Erro ao carregar fotos:', e);
                currentPhotos = [];
                displayPhotos();
            }
        }

        function showToast(message, type = 'success') {
            // Remover toast anterior se existir
            const oldToast = document.querySelector('.toast');
            if (oldToast) {
                oldToast.remove();
            }
            
            // Criar novo toast
            const toast = document.createElement('div');
            toast.className = 'toast';
            
            const colors = {
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107',
                info: '#17a2b8'
            };
            
            toast.style.background = colors[type] || colors.success;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Remover ap√≥s 3 segundos
            setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        async function saveComponentData() {
            const aero = document.getElementById('aerogerador').value;
            const mesAno = document.getElementById('mesAno').value;
            const classificacao = document.getElementById('classificacao').value;
            const falhaSelect = document.getElementById('falha').value;
            const falhaOutra = document.getElementById('falhaOutra').value.trim();
            const observacoes = document.getElementById('observacoes').value;
            
            // Determinar a falha final (do dropdown ou personalizada)
            const falha = falhaSelect === '__outra__' ? falhaOutra : falhaSelect;

            if (!aero || !mesAno) {
                alert('Por favor, preencha o aerogerador e m√™s/ano da inspe√ß√£o.');
                return;
            }

            if (!currentComponent) {
                alert('Por favor, selecione um componente.');
                return;
            }

            if (!classificacao) {
                alert('Por favor, selecione a classifica√ß√£o.');
                return;
            }

            if (classificacao !== 'Verificado' && !falha) {
                alert('Por favor, selecione ou descreva a falha quando a classifica√ß√£o n√£o for "Verificado".');
                return;
            }

            const key = `${aero}_${currentComponent.categoria}_${currentComponent.subcategoria}_${currentComponent.componente}`;
            
            // Verificar se j√° existe inspe√ß√£o para este componente
            if (inspectionData[key]) {
                const confirmacao = confirm(
                    `‚ö†Ô∏è ATEN√á√ÉO!\n\n` +
                    `Este componente j√° foi inspecionado anteriormente para ${aero}.\n\n` +
                    `Dados salvos:\n` +
                    `- Classifica√ß√£o: ${inspectionData[key].classificacao}\n` +
                    `- Falha: ${inspectionData[key].falha || 'Nenhuma'}\n` +
                    `- Data: ${new Date(inspectionData[key].timestamp).toLocaleString('pt-BR')}\n\n` +
                    `Deseja SUBSTITUIR a inspe√ß√£o anterior?`
                );
                
                if (!confirmacao) {
                    return; // Cancela o salvamento
                }
            }
            
            inspectionData[key] = {
                aerogerador: aero,
                mesAno,
                categoria: currentComponent.categoria,
                subcategoria: currentComponent.subcategoria,
                componente: currentComponent.componente,
                classificacao,
                falha: classificacao === 'Verificado' ? '' : falha,
                observacoes,
                temFotos: currentPhotos.length > 0,
                numFotos: currentPhotos.length,
                timestamp: new Date().toISOString()
            };

            // Salvar fotos separadamente no IndexedDB
            try {
                await savePhotosToDB(`photos_${key}`, currentPhotos);
            } catch (e) {
                console.error('Erro ao salvar fotos:', e);
                // Fallback para localStorage
                if (currentPhotos.length > 0) {
                    localStorage.setItem(`photos_${key}`, JSON.stringify(currentPhotos));
                } else {
                    localStorage.removeItem(`photos_${key}`);
                }
            }

            await saveToLocalStorage();
            
            // Salvar aerogerador selecionado
            const aeroSelecionado = aero;
            
            // Salvar posi√ß√£o do scroll antes de atualizar
            const treeNav = document.getElementById('treeNav');
            const scrollPos = treeNav.scrollTop;
            
            // Atualizar apenas o √≠cone do componente atual sem reconstruir toda √°rvore
            updateComponentIcon(currentComponent.categoria, currentComponent.subcategoria, currentComponent.componente);
            
            // Atualizar contadores de progresso
            updateProgress();
            updateTreeCounters();
            
            // Atualizar lista de aerogeradores para refletir progresso (sem perder sele√ß√£o)
            const selectAero = document.getElementById('aerogerador');
            selectAero.innerHTML = '<option value="">Selecione o aerogerador...</option>';
            loadAerogeradores();
            selectAero.value = aeroSelecionado; // Manter selecionado
            
            // Restaurar posi√ß√£o do scroll
            treeNav.scrollTop = scrollPos;
            
            // Remover marca√ß√£o de componente ativo
            document.querySelectorAll('.tree-component').forEach(comp => {
                comp.classList.remove('active');
            });

            showToast('‚úÖ Componente salvo com sucesso!');
            
            // Limpar formul√°rio e preparar para pr√≥ximo componente
            clearForm();
            document.getElementById('inspectionSection').style.display = 'none';
            currentComponent = null;
            
            // Scroll suave para a √°rvore de componentes
            document.getElementById('treeNav').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function clearForm() {
            document.getElementById('classificacao').value = '';
            document.getElementById('falha').value = '';
            document.getElementById('falhaOutra').value = '';
            document.getElementById('falhaOutraGroup').style.display = 'none';
            document.getElementById('observacoes').value = '';
            currentPhotos = [];
            displayPhotos();
            updateFalhaDropdown();
        }

        async function saveToLocalStorage() {
            // Salvar todas as inspe√ß√µes no IndexedDB
            try {
                for (const [key, data] of Object.entries(inspectionData)) {
                    await saveInspectionToDB(key, data);
                }
            } catch (error) {
                console.error('Erro ao salvar no IndexedDB:', error);
                // Fallback para localStorage
                localStorage.setItem('inspectionData', JSON.stringify(inspectionData));
            }
        }

        // ========== SISTEMA DE VALIDA√á√ÉO DE DADOS ==========
        
        // Campos obrigat√≥rios para cada registro de inspe√ß√£o
        const REQUIRED_FIELDS = ['aerogerador', 'mesAno', 'categoria', 'subcategoria', 'componente', 'classificacao', 'timestamp'];
        
        // Classifica√ß√µes v√°lidas
        const VALID_CLASSIFICATIONS = ['Verificado', 'Defeito Ligeiro', 'Defeito Grave', 'A√ß√£o Imediata'];
        
        /**
         * Valida um √∫nico registro de inspe√ß√£o
         * @param {string} key - Chave do registro
         * @param {object} data - Dados do registro
         * @returns {object} - { valid: boolean, errors: string[], sanitized: object|null }
         */
        function validateInspectionRecord(key, data) {
            const errors = [];
            
            // Verificar se data √© um objeto v√°lido
            if (!data || typeof data !== 'object' || Array.isArray(data)) {
                return { valid: false, errors: ['Registro n√£o √© um objeto v√°lido'], sanitized: null };
            }
            
            // Verificar campos obrigat√≥rios
            for (const field of REQUIRED_FIELDS) {
                if (data[field] === undefined || data[field] === null) {
                    errors.push(`Campo obrigat√≥rio ausente: ${field}`);
                }
            }
            
            // Se faltar campos cr√≠ticos, n√£o tenta sanitizar
            if (!data.aerogerador || !data.categoria || !data.subcategoria || !data.componente) {
                return { valid: false, errors, sanitized: null };
            }
            
            // Validar tipos dos campos
            const typeValidations = {
                aerogerador: 'string',
                mesAno: 'string',
                categoria: 'string',
                subcategoria: 'string',
                componente: 'string',
                classificacao: 'string',
                falha: 'string',
                observacoes: 'string',
                timestamp: 'string'
            };
            
            for (const [field, expectedType] of Object.entries(typeValidations)) {
                if (data[field] !== undefined && data[field] !== null && data[field] !== '') {
                    if (typeof data[field] !== expectedType) {
                        errors.push(`Campo ${field} deveria ser ${expectedType}, mas √© ${typeof data[field]}`);
                    }
                }
            }
            
            // Validar classifica√ß√£o
            if (data.classificacao && !VALID_CLASSIFICATIONS.includes(data.classificacao)) {
                errors.push(`Classifica√ß√£o inv√°lida: "${data.classificacao}"`);
            }
            
            // Validar se aerogerador existe na lista
            const aeroExists = AEROGERADORES.some(a => a.codigo === data.aerogerador);
            if (!aeroExists) {
                errors.push(`Aerogerador n√£o encontrado: "${data.aerogerador}"`);
            }
            
            // Validar se categoria existe na estrutura
            if (!ESTRUTURA.categorias[data.categoria]) {
                errors.push(`Categoria n√£o encontrada: "${data.categoria}"`);
            } else {
                // Validar subcategoria
                if (!ESTRUTURA.categorias[data.categoria][data.subcategoria]) {
                    errors.push(`Subcategoria n√£o encontrada: "${data.subcategoria}"`);
                } else {
                    // Validar componente
                    if (!ESTRUTURA.categorias[data.categoria][data.subcategoria][data.componente]) {
                        errors.push(`Componente n√£o encontrado: "${data.componente}"`);
                    } else {
                        // Validar falha se classifica√ß√£o n√£o for "Verificado"
                        if (data.classificacao && data.classificacao !== 'Verificado' && data.falha) {
                            const falhasValidas = ESTRUTURA.categorias[data.categoria][data.subcategoria][data.componente].falhas || [];
                            if (!falhasValidas.includes(data.falha)) {
                                errors.push(`Falha n√£o encontrada para este componente: "${data.falha}"`);
                            }
                        }
                    }
                }
            }
            
            // Validar formato do mesAno (YYYY-MM)
            if (data.mesAno && !/^\d{4}-\d{2}$/.test(data.mesAno)) {
                errors.push(`Formato de m√™s/ano inv√°lido: "${data.mesAno}"`);
            }
            
            // Validar timestamp
            if (data.timestamp) {
                const date = new Date(data.timestamp);
                if (isNaN(date.getTime())) {
                    errors.push(`Timestamp inv√°lido: "${data.timestamp}"`);
                }
            }
            
            // Validar consist√™ncia da chave
            const expectedKey = `${data.aerogerador}_${data.categoria}_${data.subcategoria}_${data.componente}`;
            if (key !== expectedKey) {
                errors.push(`Chave inconsistente: esperado "${expectedKey}", encontrado "${key}"`);
            }
            
            // Validar campos booleanos e num√©ricos
            if (data.temFotos !== undefined && typeof data.temFotos !== 'boolean') {
                errors.push(`Campo temFotos deveria ser boolean`);
            }
            
            if (data.numFotos !== undefined && (typeof data.numFotos !== 'number' || data.numFotos < 0)) {
                errors.push(`Campo numFotos deveria ser n√∫mero n√£o-negativo`);
            }
            
            // Se h√° erros cr√≠ticos (estrutura), n√£o sanitiza
            const criticalErrors = errors.filter(e => 
                e.includes('n√£o encontrado') || 
                e.includes('Chave inconsistente') ||
                e.includes('n√£o √© um objeto')
            );
            
            if (criticalErrors.length > 0) {
                return { valid: false, errors, sanitized: null };
            }
            
            // Sanitizar dados (corrigir problemas menores)
            const sanitized = {
                aerogerador: String(data.aerogerador || '').trim(),
                mesAno: String(data.mesAno || '').trim(),
                categoria: String(data.categoria || '').trim(),
                subcategoria: String(data.subcategoria || '').trim(),
                componente: String(data.componente || '').trim(),
                classificacao: VALID_CLASSIFICATIONS.includes(data.classificacao) ? data.classificacao : 'Verificado',
                falha: String(data.falha || '').trim(),
                observacoes: String(data.observacoes || '').trim(),
                temFotos: Boolean(data.temFotos),
                numFotos: Math.max(0, parseInt(data.numFotos) || 0),
                timestamp: data.timestamp || new Date().toISOString()
            };
            
            // Se classifica√ß√£o √© Verificado, limpar falha
            if (sanitized.classificacao === 'Verificado') {
                sanitized.falha = '';
            }
            
            return { 
                valid: errors.length === 0, 
                errors, 
                sanitized 
            };
        }
        
        /**
         * Valida todos os dados de inspe√ß√£o carregados
         * @param {object} data - Objeto com todos os registros
         * @returns {object} - { validData: object, invalidKeys: string[], totalErrors: number, report: string }
         */
        function validateAllInspectionData(data) {
            const validData = {};
            const invalidKeys = [];
            const allErrors = [];
            let totalErrors = 0;
            
            if (!data || typeof data !== 'object') {
                return { 
                    validData: {}, 
                    invalidKeys: [], 
                    totalErrors: 1, 
                    report: '‚ùå Dados n√£o s√£o um objeto v√°lido. Iniciando com dados vazios.' 
                };
            }
            
            for (const [key, record] of Object.entries(data)) {
                const validation = validateInspectionRecord(key, record);
                
                if (validation.sanitized) {
                    validData[key] = validation.sanitized;
                    
                    if (!validation.valid) {
                        // Dados foram sanitizados mas tinham problemas menores
                        allErrors.push(`‚ö†Ô∏è ${key}: ${validation.errors.join(', ')}`);
                        totalErrors += validation.errors.length;
                    }
                } else {
                    // Dados inv√°lidos, n√£o podem ser recuperados
                    invalidKeys.push(key);
                    allErrors.push(`‚ùå ${key}: ${validation.errors.join(', ')}`);
                    totalErrors += validation.errors.length;
                }
            }
            
            // Gerar relat√≥rio
            let report = '';
            const totalRecords = Object.keys(data).length;
            const validRecords = Object.keys(validData).length;
            
            if (totalErrors === 0) {
                report = `‚úÖ Todos os ${totalRecords} registros foram validados com sucesso.`;
            } else {
                report = `üìä Valida√ß√£o conclu√≠da:\n`;
                report += `‚Ä¢ ${validRecords} de ${totalRecords} registros v√°lidos\n`;
                report += `‚Ä¢ ${invalidKeys.length} registros removidos por erros cr√≠ticos\n`;
                report += `‚Ä¢ ${totalErrors} problemas encontrados no total\n\n`;
                
                if (allErrors.length <= 10) {
                    report += `Detalhes:\n${allErrors.join('\n')}`;
                } else {
                    report += `Primeiros 10 problemas:\n${allErrors.slice(0, 10).join('\n')}\n... e mais ${allErrors.length - 10} problemas.`;
                }
            }
            
            return { validData, invalidKeys, totalErrors, report };
        }
        
        /**
         * Valida fotos armazenadas no localStorage
         * @param {string} key - Chave da foto
         * @returns {array} - Array de fotos v√°lidas (base64)
         */
        function validatePhotos(key) {
            try {
                const photosJson = localStorage.getItem(`photos_${key}`);
                if (!photosJson) return [];
                
                const photos = JSON.parse(photosJson);
                
                if (!Array.isArray(photos)) {
                    console.warn(`Fotos para ${key} n√£o s√£o um array v√°lido`);
                    return [];
                }
                
                // Filtrar apenas strings base64 v√°lidas
                return photos.filter(photo => {
                    if (typeof photo !== 'string') return false;
                    // Verificar se √© uma string base64 de imagem v√°lida
                    return photo.startsWith('data:image/') && photo.includes('base64,');
                });
                
            } catch (e) {
                console.error(`Erro ao validar fotos para ${key}:`, e);
                return [];
            }
        }
        
        /**
         * Carrega e valida dados salvos do IndexedDB (com fallback para localStorage)
         */
        async function loadSavedData() {
            try {
                // Tentar carregar do IndexedDB primeiro
                let rawData = await loadAllInspectionsFromDB();
                
                // Se IndexedDB estiver vazio, tentar migrar do localStorage
                if (Object.keys(rawData).length === 0) {
                    const saved = localStorage.getItem('inspectionData');
                    if (saved) {
                        console.log('Migrando dados do localStorage para IndexedDB...');
                        rawData = JSON.parse(saved);
                        
                        // Salvar no IndexedDB
                        for (const [key, data] of Object.entries(rawData)) {
                            await saveInspectionToDB(key, data);
                        }
                        
                        // Migrar fotos tamb√©m
                        for (let i = 0; i < localStorage.length; i++) {
                            const lsKey = localStorage.key(i);
                            if (lsKey.startsWith('photos_')) {
                                const photos = JSON.parse(localStorage.getItem(lsKey));
                                await savePhotosToDB(lsKey, photos);
                            }
                        }
                        
                        console.log('Migra√ß√£o conclu√≠da! Dados movidos para IndexedDB.');
                        showToast('üì¶ Dados migrados para novo formato!', 'success');
                    }
                }
                
                if (Object.keys(rawData).length === 0) {
                    inspectionData = {};
                    updateProgress();
                    return;
                }
                
                // Validar todos os dados
                const validation = validateAllInspectionData(rawData);
                
                // Usar apenas dados v√°lidos/sanitizados
                inspectionData = validation.validData;
                
                // Se houve problemas, informar o usu√°rio
                if (validation.totalErrors > 0) {
                    console.warn('Problemas encontrados nos dados salvos:', validation.report);
                    
                    // Mostrar alerta apenas se houve registros removidos
                    if (validation.invalidKeys.length > 0) {
                        setTimeout(() => {
                            showToast(`‚ö†Ô∏è ${validation.invalidKeys.length} registro(s) inv√°lido(s) foram ignorados`, 'warning');
                        }, 1000);
                    }
                }
                
                // Log detalhado no console para debug
                console.log('=== VALIDA√á√ÉO DE DADOS ===');
                console.log(validation.report);
                console.log('Registros carregados:', Object.keys(inspectionData).length);
                
            } catch (e) {
                console.error('Erro cr√≠tico ao carregar dados:', e);
                inspectionData = {};
                showToast('‚ùå Erro ao carregar dados', 'error');
            }
            
            updateProgress();
        }

        function updateProgress() {
            const aero = document.getElementById('aerogerador').value;
            const completed = Object.keys(inspectionData).filter(key => {
                return aero && key.startsWith(aero + '_');
            }).length;

            const percentage = (completed / totalComponentes) * 100;
            document.getElementById('progressText').textContent = `${completed} de ${totalComponentes} componentes`;
            document.getElementById('progressFill').style.width = `${percentage}%`;
            
            // Atualizar progresso do parque (aerogeradores completos)
            updateParqueProgress();
        }
        
        function updateParqueProgress() {
            let totalAeros = AEROGERADORES.length;
            let completosAeros = 0;
            
            AEROGERADORES.forEach(aero => {
                const progresso = getAerogeradorProgress(aero.codigo);
                if (progresso.percentual === 100) {
                    completosAeros++;
                }
            });
            
            const percentualParque = totalAeros > 0 ? (completosAeros / totalAeros) * 100 : 0;
            
            document.getElementById('progressoParque').innerHTML = 
                `üìä Aerogeradores completos: <strong>${completosAeros}/${totalAeros}</strong> (${Math.round(percentualParque)}%)`;
            document.getElementById('progressoParqueBarra').style.width = `${percentualParque}%`;
        }

        function exportData() {
            const aero = document.getElementById('aerogerador').value;
            if (!aero) {
                alert('Por favor, selecione um aerogerador para exportar.');
                return;
            }

            const filteredData = Object.entries(inspectionData)
                .filter(([key]) => key.startsWith(aero + '_'))
                .map(([_, data]) => data);

            if (filteredData.length === 0) {
                alert('N√£o h√° dados para exportar para este aerogerador.');
                return;
            }

            exportToCSV(filteredData, `inspecao_${aero}_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function exportAllData() {
            const allData = Object.values(inspectionData);
            
            if (allData.length === 0) {
                alert('N√£o h√° dados para exportar.');
                return;
            }

            exportToCSV(allData, `inspecao_TODAS_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function exportToCSV(data, filename) {
            const headers = ['Aerogerador', 'M√™s/Ano', 'Categoria', 'Sub-categoria', 'Componente', 'Classifica√ß√£o', 'Falha', 'Observa√ß√µes', 'Tem Fotos', 'Num Fotos', 'Data/Hora'];
            const csv = [
                headers.join(','),
                ...data.map(row => [
                    row.aerogerador,
                    row.mesAno,
                    `"${row.categoria}"`,
                    `"${row.subcategoria}"`,
                    `"${row.componente}"`,
                    row.classificacao,
                    `"${row.falha || ''}"`,
                    `"${(row.observacoes || '').replace(/"/g, '""')}"`,
                    row.temFotos ? 'Sim' : 'N√£o',
                    row.numFotos || 0,
                    row.timestamp
                ].join(','))
            ].join('\n');

            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();

            showToast('‚úÖ Dados exportados com sucesso!');
        }

        function viewSavedData() {
            const aero = document.getElementById('aerogerador').value;
            if (!aero) {
                alert('Por favor, selecione um aerogerador.');
                return;
            }

            const filteredData = Object.entries(inspectionData)
                .filter(([key]) => key.startsWith(aero + '_'))
                .map(([_, data]) => data);

            if (filteredData.length === 0) {
                alert('N√£o h√° dados para gerar o relat√≥rio deste aerogerador.');
                return;
            }

            // Agrupar por categoria
            const porCategoria = {};
            filteredData.forEach(data => {
                if (!porCategoria[data.categoria]) {
                    porCategoria[data.categoria] = [];
                }
                porCategoria[data.categoria].push(data);
            });

            // Criar modal de relat√≥rio dentro do pr√≥prio app
            let modalHtml = `
                <div id="reportModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: white;
                    z-index: 9999;
                    overflow-y: auto;
                    padding: 20px;
                    box-sizing: border-box;
                ">
                    <div style="max-width: 900px; margin: 0 auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: sticky; top: 0; background: white; padding: 10px 0; border-bottom: 2px solid #e0e0e0;">
                            <button onclick="document.getElementById('reportModal').remove()" style="
                                background: #0000FF;
                                color: white;
                                border: none;
                                padding: 12px 20px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 16px;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            ">‚Üê Voltar</button>
                            <button onclick="window.print()" style="
                                background: #28a745;
                                color: white;
                                border: none;
                                padding: 12px 20px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 16px;
                            ">üñ®Ô∏è Imprimir</button>
                        </div>
                        
                        <h2 style="color: #0000FF;">Relat√≥rio - ${aero}</h2>
                        <p>Total de componentes inspecionados: <strong>${filteredData.length}</strong></p>
                        <hr style="border: none; border-top: 2px solid #e0e0e0; margin: 20px 0;">
                        
                        <div id="reportContent">Carregando fotos...</div>
                    </div>
                </div>
            `;
            
            // Adicionar modal ao DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Construir conte√∫do com fotos do IndexedDB
            buildReportContent(porCategoria, aero);
        }
        
        async function buildReportContent(porCategoria, aero) {
            let contentHtml = '';
            
            for (const [categoria, items] of Object.entries(porCategoria)) {
                contentHtml += `<h3 style="color: #0066FF; margin-top: 20px;">üìÅ ${categoria}</h3><ul style="line-height: 1.6; list-style: none; padding: 0;">`;
                
                for (const data of items) {
                    // Determinar classe de cor baseado na classifica√ß√£o
                    let cor = '#28a745';
                    if (data.classificacao === 'Defeito Ligeiro') cor = '#ffc107';
                    else if (data.classificacao === 'Defeito Grave') cor = '#fd7e14';
                    else if (data.classificacao === 'A√ß√£o Imediata') cor = '#dc3545';
                    
                    contentHtml += `<li style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">`;
                    contentHtml += `<strong>${data.componente}</strong>: <span style="color: ${cor}; ${data.classificacao === 'A√ß√£o Imediata' ? 'font-weight: bold;' : ''}">${data.classificacao}</span>`;
                    if (data.falha) contentHtml += ` - ${data.falha}`;
                    if (data.observacoes) contentHtml += `<br><em>${data.observacoes}</em>`;
                    
                    // Carregar fotos do IndexedDB
                    if (data.temFotos && data.numFotos > 0) {
                        const photoKey = `photos_${aero}_${data.categoria}_${data.subcategoria}_${data.componente}`;
                        try {
                            const photos = await loadPhotosFromDB(photoKey);
                            if (photos && photos.length > 0) {
                                contentHtml += `<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">`;
                                photos.forEach((photo, idx) => {
                                    contentHtml += `<div style="width: 100px; height: 100px; border-radius: 6px; overflow: hidden; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.15);" onclick="showPhotoFullscreen('${photo.replace(/'/g, "\\'")}')">`;
                                    contentHtml += `<img src="${photo}" alt="Foto ${idx + 1}" style="width: 100%; height: 100%; object-fit: cover;">`;
                                    contentHtml += `</div>`;
                                });
                                contentHtml += `</div>`;
                            }
                        } catch (e) {
                            contentHtml += `<br>üì∏ ${data.numFotos} foto(s) - erro ao carregar`;
                        }
                    }
                    
                    contentHtml += `</li>`;
                }
                contentHtml += `</ul>`;
            }
            
            document.getElementById('reportContent').innerHTML = contentHtml;
        }
        
        function showPhotoFullscreen(photoSrc) {
            const modal = document.createElement('div');
            modal.id = 'photoFullscreenModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.95);
                z-index: 99999;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
            `;
            modal.innerHTML = `
                <span style="position: absolute; top: 20px; right: 30px; font-size: 40px; color: white; cursor: pointer;">&times;</span>
                <img src="${photoSrc}" style="max-width: 95%; max-height: 95%; object-fit: contain; border-radius: 8px;">
            `;
            modal.onclick = () => modal.remove();
            document.body.appendChild(modal);
        }

        /**
         * Exporta o relat√≥rio como arquivo HTML para compartilhar
         */
        async function exportReportHTML() {
            const aero = document.getElementById('aerogerador').value;
            
            if (!aero) {
                showToast('‚ö†Ô∏è Selecione um aerogerador primeiro!', 'warning');
                return;
            }

            const filteredData = Object.entries(inspectionData)
                .filter(([key]) => key.startsWith(aero + '_'))
                .map(([, data]) => data);

            if (filteredData.length === 0) {
                showToast('‚ö†Ô∏è Nenhum dado encontrado para este aerogerador', 'warning');
                return;
            }

            showToast('‚è≥ Gerando relat√≥rio...', 'info');

            // Agrupar por categoria
            const porCategoria = {};
            filteredData.forEach(data => {
                if (!porCategoria[data.categoria]) {
                    porCategoria[data.categoria] = [];
                }
                porCategoria[data.categoria].push(data);
            });

            // Construir HTML completo
            let html = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio de Inspe√ß√£o - ${aero}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #0000FF 0%, #0066FF 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center; }
        .header h1 { font-size: 24px; margin-bottom: 10px; }
        .header p { opacity: 0.9; }
        .summary { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .summary h2 { color: #0000FF; margin-bottom: 15px; }
        .stats { display: flex; gap: 20px; flex-wrap: wrap; }
        .stat { background: #f0f0ff; padding: 15px 25px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 28px; font-weight: bold; color: #0000FF; }
        .stat-label { font-size: 12px; color: #666; }
        .categoria { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .categoria h3 { color: #0066FF; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        .componente { padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px; }
        .componente-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .componente-nome { font-weight: bold; }
        .classificacao { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .classificacao-verificado { background: #d4edda; color: #155724; }
        .classificacao-ligeiro { background: #fff3cd; color: #856404; }
        .classificacao-grave { background: #ffe0b2; color: #e65100; }
        .classificacao-imediata { background: #f8d7da; color: #721c24; }
        .falha { color: #dc3545; font-size: 14px; margin-bottom: 5px; }
        .observacoes { color: #666; font-style: italic; font-size: 14px; }
        .fotos { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .foto { width: 120px; height: 120px; border-radius: 8px; object-fit: cover; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
        .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }
        @media print { body { background: white; } .header, .categoria, .summary { box-shadow: none; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå¨Ô∏è Relat√≥rio de Inspe√ß√£o Eletromec√¢nica</h1>
        <p><strong>Aerogerador:</strong> ${aero}</p>
        <p><strong>Data do Relat√≥rio:</strong> ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}</p>
    </div>

    <div class="summary">
        <h2>üìä Resumo</h2>
        <div class="stats">
            <div class="stat">
                <div class="stat-value">${filteredData.length}</div>
                <div class="stat-label">Componentes Inspecionados</div>
            </div>
            <div class="stat">
                <div class="stat-value">${filteredData.filter(d => d.classificacao === 'Verificado').length}</div>
                <div class="stat-label">Verificados ‚úÖ</div>
            </div>
            <div class="stat">
                <div class="stat-value">${filteredData.filter(d => d.classificacao === 'Defeito Ligeiro').length}</div>
                <div class="stat-label">Defeitos Ligeiros ‚ö†Ô∏è</div>
            </div>
            <div class="stat">
                <div class="stat-value">${filteredData.filter(d => d.classificacao === 'Defeito Grave').length}</div>
                <div class="stat-label">Defeitos Graves üî∂</div>
            </div>
            <div class="stat">
                <div class="stat-value">${filteredData.filter(d => d.classificacao === 'A√ß√£o Imediata').length}</div>
                <div class="stat-label">A√ß√µes Imediatas üî¥</div>
            </div>
        </div>
    </div>`;

            // Adicionar categorias
            for (const [categoria, items] of Object.entries(porCategoria)) {
                html += `
    <div class="categoria">
        <h3>üìÅ ${categoria}</h3>`;
                
                for (const data of items) {
                    let classeClass = 'classificacao-verificado';
                    if (data.classificacao === 'Defeito Ligeiro') classeClass = 'classificacao-ligeiro';
                    else if (data.classificacao === 'Defeito Grave') classeClass = 'classificacao-grave';
                    else if (data.classificacao === 'A√ß√£o Imediata') classeClass = 'classificacao-imediata';
                    
                    html += `
        <div class="componente">
            <div class="componente-header">
                <span class="componente-nome">${data.componente}</span>
                <span class="classificacao ${classeClass}">${data.classificacao}</span>
            </div>`;
                    
                    if (data.falha) {
                        html += `<div class="falha">‚ö†Ô∏è ${data.falha}</div>`;
                    }
                    if (data.observacoes) {
                        html += `<div class="observacoes">üìù ${data.observacoes}</div>`;
                    }
                    
                    // Adicionar fotos
                    if (data.temFotos && data.numFotos > 0) {
                        const photoKey = `photos_${aero}_${data.categoria}_${data.subcategoria}_${data.componente}`;
                        try {
                            const photos = await loadPhotosFromDB(photoKey);
                            if (photos && photos.length > 0) {
                                html += `<div class="fotos">`;
                                photos.forEach(photo => {
                                    html += `<img src="${photo}" class="foto" alt="Foto">`;
                                });
                                html += `</div>`;
                            }
                        } catch (e) {
                            console.error('Erro ao carregar fotos:', e);
                        }
                    }
                    
                    html += `</div>`;
                }
                
                html += `</div>`;
            }

            html += `
    <div class="footer">
        <p>Relat√≥rio gerado pelo App de Inspe√ß√µes Eletromec√¢nicas dos Parques E√≥licos</p>
        <p>¬© ${new Date().getFullYear()} - AXIA Energia</p>
    </div>
</body>
</html>`;

            // Abrir relat√≥rio em modal com op√ß√µes
            const modalHtml = `
                <div id="exportModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: white;
                    z-index: 9999;
                    overflow-y: auto;
                ">
                    <div style="position: sticky; top: 0; background: #0000FF; padding: 15px; display: flex; justify-content: space-between; align-items: center; z-index: 10000;">
                        <button onclick="document.getElementById('exportModal').remove()" style="
                            background: white;
                            color: #0000FF;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 8px;
                            font-weight: bold;
                            cursor: pointer;
                        ">‚Üê Voltar</button>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="compartilharRelatorio()" style="
                                background: #25D366;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 8px;
                                font-weight: bold;
                                cursor: pointer;
                            ">üì§ Compartilhar</button>
                            <button onclick="window.print()" style="
                                background: white;
                                color: #0000FF;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 8px;
                                font-weight: bold;
                                cursor: pointer;
                            ">üñ®Ô∏è Imprimir</button>
                        </div>
                    </div>
                    <iframe id="relatorioFrame" style="width: 100%; height: calc(100% - 70px); border: none;"></iframe>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Escrever conte√∫do no iframe
            const iframe = document.getElementById('relatorioFrame');
            const iframeDoc = iframe.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(html);
            iframeDoc.close();
            
            // Guardar HTML para compartilhar
            window.relatorioHTML = html;
            window.relatorioAero = aero;
        }
        
        async function compartilharRelatorio() {
            const aero = window.relatorioAero;
            const html = window.relatorioHTML;
            const fileName = `relatorio_${aero}_${new Date().toISOString().split('T')[0]}.html`;
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const file = new File([blob], fileName, { type: 'text/html' });
            
            // Tentar compartilhamento nativo com arquivo
            if (navigator.share) {
                try {
                    // Primeiro tenta com arquivo
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            files: [file],
                            title: `Relat√≥rio - ${aero}`
                        });
                        showToast('‚úÖ Compartilhado!', 'success');
                        return;
                    }
                } catch (e) {
                    console.log('Compartilhamento de arquivo falhou:', e);
                }
                
                // Se n√£o deu, tenta s√≥ com texto
                try {
                    await navigator.share({
                        title: `Relat√≥rio de Inspe√ß√£o - ${aero}`,
                        text: `Relat√≥rio de inspe√ß√£o do aerogerador ${aero}. Abra o arquivo HTML anexo para ver os detalhes completos com fotos.`
                    });
                    showToast('üí° Compartilhe o arquivo manualmente', 'info');
                    return;
                } catch (e) {
                    if (e.name === 'AbortError') return;
                }
            }
            
            // Fallback: baixar arquivo
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.click();
            URL.revokeObjectURL(url);
            showToast('‚úÖ Arquivo salvo em Downloads!', 'success');
        }

        // ========== SISTEMA DE BACKUP E RESTAURA√á√ÉO ==========

        /**
         * Cria um backup completo de todos os dados (inspe√ß√µes + fotos)
         */
        async function createBackup() {
            console.log('=== CRIANDO BACKUP ===');
            
            const backup = {
                version: '2.0',
                createdAt: new Date().toISOString(),
                appName: 'Inspe√ß√£o de Torres E√≥licas - Coxilha Negra (PWA)',
                data: {
                    inspectionData: {},
                    photos: {}
                }
            };

            try {
                // Carregar dados de inspe√ß√£o do IndexedDB
                backup.data.inspectionData = await loadAllInspectionsFromDB();
                
                // Carregar todas as fotos do IndexedDB
                backup.data.photos = await loadAllPhotosFromDB();
                
            } catch (e) {
                console.error('Erro ao ler dados do IndexedDB:', e);
                // Fallback para localStorage
                const inspectionDataJson = localStorage.getItem('inspectionData');
                if (inspectionDataJson) {
                    backup.data.inspectionData = JSON.parse(inspectionDataJson);
                }
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('photos_')) {
                        backup.data.photos[key] = JSON.parse(localStorage.getItem(key));
                    }
                }
            }

            // Estat√≠sticas do backup
            const numInspecoes = Object.keys(backup.data.inspectionData).length;
            const numFotosKeys = Object.keys(backup.data.photos).length;
            let numFotosTotal = 0;
            for (const photos of Object.values(backup.data.photos)) {
                if (Array.isArray(photos)) {
                    numFotosTotal += photos.length;
                }
            }

            console.log(`Backup: ${numInspecoes} inspe√ß√µes, ${numFotosTotal} fotos`);

            // Criar arquivo e baixar
            const jsonStr = JSON.stringify(backup);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const date = new Date().toISOString().split('T')[0];
            const filename = `backup_inspecao_${date}.json`;
            
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            
            URL.revokeObjectURL(url);

            showToast(`‚úÖ Backup criado! ${numInspecoes} inspe√ß√µes, ${numFotosTotal} fotos`, 'success');
        }

        /**
         * Restaura dados de um arquivo de backup
         */
        async function restoreBackup(file) {
            console.log('=== RESTAURANDO BACKUP ===');
            
            if (!file) {
                showToast('‚ùå Nenhum arquivo selecionado', 'error');
                return;
            }

            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    // Validar estrutura do backup
                    if (!backup.data || !backup.version) {
                        throw new Error('Arquivo de backup inv√°lido');
                    }

                    // Contar o que ser√° restaurado
                    const numInspecoes = Object.keys(backup.data.inspectionData || {}).length;
                    const numFotosKeys = Object.keys(backup.data.photos || {}).length;
                    let numFotosTotal = 0;
                    for (const photos of Object.values(backup.data.photos || {})) {
                        if (Array.isArray(photos)) {
                            numFotosTotal += photos.length;
                        }
                    }

                    // Confirmar com o usu√°rio
                    const dataBackup = new Date(backup.createdAt).toLocaleString('pt-BR');
                    const confirmMsg = `‚ö†Ô∏è ATEN√á√ÉO!\n\n` +
                        `Voc√™ est√° prestes a restaurar um backup de ${dataBackup}.\n\n` +
                        `Conte√∫do do backup:\n` +
                        `‚Ä¢ ${numInspecoes} inspe√ß√µes\n` +
                        `‚Ä¢ ${numFotosTotal} fotos\n\n` +
                        `Isso ir√° SUBSTITUIR todos os dados atuais.\n\n` +
                        `Deseja continuar?`;

                    if (!confirm(confirmMsg)) {
                        showToast('Restaura√ß√£o cancelada', 'info');
                        return;
                    }

                    // Limpar dados atuais do IndexedDB
                    try {
                        await clearAllDB();
                    } catch (e) {
                        console.warn('Erro ao limpar IndexedDB:', e);
                    }

                    // Restaurar dados de inspe√ß√£o no IndexedDB
                    if (backup.data.inspectionData && Object.keys(backup.data.inspectionData).length > 0) {
                        for (const [key, data] of Object.entries(backup.data.inspectionData)) {
                            await saveInspectionToDB(key, data);
                        }
                        inspectionData = backup.data.inspectionData;
                    }

                    // Restaurar fotos no IndexedDB
                    if (backup.data.photos) {
                        for (const [key, photos] of Object.entries(backup.data.photos)) {
                            if (Array.isArray(photos) && photos.length > 0) {
                                await savePhotosToDB(key, photos);
                            }
                        }
                    }

                    // Atualizar interface
                    await loadSavedData();
                    buildTree();
                    updateProgress();
                    updateParqueProgress();

                    // Recarregar lista de aerogeradores
                    const selectAero = document.getElementById('aerogerador');
                    const currentAero = selectAero.value;
                    selectAero.innerHTML = '<option value="">Selecione o aerogerador...</option>';
                    loadAerogeradores();
                    if (currentAero) {
                        selectAero.value = currentAero;
                    }

                    showToast(`‚úÖ Backup restaurado! ${numInspecoes} inspe√ß√µes, ${numFotosTotal} fotos`, 'success');
                    console.log('Backup restaurado com sucesso');

                } catch (error) {
                    console.error('Erro ao restaurar backup:', error);
                    showToast('‚ùå Erro ao ler arquivo de backup: ' + error.message, 'error');
                }
            };

            reader.onerror = function() {
                showToast('‚ùå Erro ao ler arquivo', 'error');
            };

            reader.readAsText(file);
        }

        // Vari√°vel global para armazenar o relat√≥rio atual (para copiar JSON)
        let currentDiagnosticReport = null;

        /**
         * Abre o modal de diagn√≥stico
         */
        function openDiagnosticModal() {
            document.getElementById('diagnosticModal').style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Impedir scroll do body
        }

        /**
         * Fecha o modal de diagn√≥stico
         */
        function closeDiagnosticModal() {
            document.getElementById('diagnosticModal').style.display = 'none';
            document.body.style.overflow = ''; // Restaurar scroll
        }

        /**
         * Abre o modal com a foto ampliada
         */
        function openPhotoModal(photoSrc) {
            document.getElementById('photoModalImg').src = photoSrc;
            document.getElementById('photoModal').style.display = 'flex';
        }

        /**
         * Fecha o modal de foto
         */
        function closePhotoModal() {
            document.getElementById('photoModal').style.display = 'none';
            document.getElementById('photoModalImg').src = '';
        }

        /**
         * Executa diagn√≥stico completo dos dados e IndexedDB
         */
        async function runDiagnostics() {
            console.log('=== INICIANDO DIAGN√ìSTICO ===');
            
            const report = {
                timestamp: new Date().toISOString(),
                storage: {},
                inspectionData: {},
                photos: {},
                estrutura: {},
                recommendations: []
            };
            
            // 1. An√°lise do armazenamento (IndexedDB)
            try {
                const stats = await getStorageStats();
                if (stats) {
                    report.storage = {
                        type: 'IndexedDB (PWA)',
                        usage: stats.usage,
                        quota: stats.quota,
                        usageFormatted: stats.usageFormatted,
                        quotaFormatted: stats.quotaFormatted,
                        percentUsed: stats.percentUsed
                    };
                    
                    const percentNum = parseFloat(stats.percentUsed);
                    if (percentNum > 80) {
                        report.recommendations.push('‚ö†Ô∏è Armazenamento est√° quase cheio (' + stats.percentUsed + ').');
                    }
                } else {
                    report.storage = {
                        type: 'IndexedDB (PWA)',
                        usageFormatted: 'N/A',
                        quotaFormatted: 'Ilimitado*',
                        percentUsed: 'N/A'
                    };
                }
            } catch (e) {
                report.storage.error = e.message;
            }
            
            // 2. An√°lise dos dados de inspe√ß√£o
            try {
                const rawData = await loadAllInspectionsFromDB();
                if (Object.keys(rawData).length > 0) {
                    const validation = validateAllInspectionData(rawData);
                    
                    report.inspectionData = {
                        totalRecords: Object.keys(rawData).length,
                        validRecords: Object.keys(validation.validData).length,
                        invalidRecords: validation.invalidKeys.length,
                        totalErrors: validation.totalErrors,
                        invalidKeys: validation.invalidKeys,
                        validationReport: validation.report
                    };
                    
                    // Estat√≠sticas por aerogerador
                    const byAero = {};
                    for (const [key, data] of Object.entries(validation.validData)) {
                        const aero = data.aerogerador;
                        if (!byAero[aero]) {
                            byAero[aero] = { count: 0, classifications: {} };
                        }
                        byAero[aero].count++;
                        byAero[aero].classifications[data.classificacao] = 
                            (byAero[aero].classifications[data.classificacao] || 0) + 1;
                    }
                    report.inspectionData.byAerogerador = byAero;
                    
                } else {
                    report.inspectionData = { message: 'Nenhum dado de inspe√ß√£o encontrado', totalRecords: 0, validRecords: 0, invalidRecords: 0 };
                }
            } catch (e) {
                report.inspectionData.error = 'Erro ao carregar dados: ' + e.message;
                report.recommendations.push('‚ùå Erro ao acessar dados de inspe√ß√£o.');
            }
            
            // 3. An√°lise das fotos
            let totalPhotos = 0;
            const photoKeys = [];
            
            try {
                const allPhotos = await loadAllPhotosFromDB();
                for (const [key, photos] of Object.entries(allPhotos)) {
                    if (Array.isArray(photos) && photos.length > 0) {
                        photoKeys.push(key);
                        totalPhotos += photos.length;
                    }
                }
            } catch (e) {
                console.error('Erro ao carregar fotos para diagn√≥stico:', e);
            }
            
            report.photos = {
                totalPhotoKeys: photoKeys.length,
                totalPhotos: totalPhotos,
                totalSize: 'Armazenado no IndexedDB',
                keys: photoKeys
            };
            
            // 4. An√°lise da estrutura
            report.estrutura = {
                totalCategorias: Object.keys(ESTRUTURA.categorias).length,
                totalComponentes: totalComponentes,
                totalAerogeradores: AEROGERADORES.length
            };
            
            // 5. Verificar backups
            if (localStorage.getItem('inspectionData_backup_corrupted')) {
                report.recommendations.push('‚ÑπÔ∏è Existe um backup de dados corrompidos. Pode ser removido se n√£o for necess√°rio.');
            }

            // Guardar relat√≥rio para fun√ß√£o de copiar
            currentDiagnosticReport = report;
            
            // Gerar conte√∫do do modal
            const content = document.getElementById('diagnosticContent');
            
            // Determinar status geral
            const hasProblems = report.recommendations.length > 0 || report.inspectionData.invalidRecords > 0;
            
            content.innerHTML = `
                <p style="color: #666; margin-bottom: 20px;">Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
                
                <!-- Status Geral -->
                <div class="diag-card">
                    ${hasProblems ? 
                        `<div class="diag-alert warning">‚ö†Ô∏è Foram encontrados alguns pontos de aten√ß√£o</div>` :
                        `<div class="diag-alert success">‚úÖ Sistema PWA funcionando corretamente!</div>`
                    }
                </div>
                
                <!-- Armazenamento IndexedDB -->
                <div class="diag-card">
                    <h3>üíæ Armazenamento (IndexedDB)</h3>
                    <div class="diag-stats">
                        <div class="diag-stat">
                            <div class="diag-stat-value">${report.storage.usageFormatted || 'N/A'}</div>
                            <div class="diag-stat-label">Espa√ßo usado</div>
                        </div>
                        <div class="diag-stat">
                            <div class="diag-stat-value">${report.storage.quotaFormatted || 'Ilimitado*'}</div>
                            <div class="diag-stat-label">Dispon√≠vel</div>
                        </div>
                        <div class="diag-stat">
                            <div class="diag-stat-value">${report.storage.percentUsed || '<1%'}</div>
                            <div class="diag-stat-label">Utiliza√ß√£o</div>
                        </div>
                    </div>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">* IndexedDB permite armazenar muito mais dados que localStorage</p>
                </div>
                
                <!-- Dados de Inspe√ß√£o -->
                <div class="diag-card">
                    <h3>üìã Dados de Inspe√ß√£o</h3>
                    ${report.inspectionData.error ? 
                        `<div class="diag-alert error">${report.inspectionData.error}</div>` :
                        `<div class="diag-stats">
                            <div class="diag-stat">
                                <div class="diag-stat-value">${report.inspectionData.totalRecords || 0}</div>
                                <div class="diag-stat-label">Registros totais</div>
                            </div>
                            <div class="diag-stat">
                                <div class="diag-stat-value" style="color: #28a745;">${report.inspectionData.validRecords || 0}</div>
                                <div class="diag-stat-label">V√°lidos</div>
                            </div>
                            <div class="diag-stat">
                                <div class="diag-stat-value" style="color: ${report.inspectionData.invalidRecords > 0 ? '#dc3545' : '#28a745'};">${report.inspectionData.invalidRecords || 0}</div>
                                <div class="diag-stat-label">Inv√°lidos</div>
                            </div>
                        </div>
                        ${report.inspectionData.invalidRecords > 0 ? 
                            `<div class="diag-alert warning" style="margin-top: 15px;">
                                <strong>Registros com problemas:</strong><br>
                                ${report.inspectionData.invalidKeys.slice(0, 5).join('<br>')}
                                ${report.inspectionData.invalidKeys.length > 5 ? `<br>... e mais ${report.inspectionData.invalidKeys.length - 5}` : ''}
                            </div>` : 
                            ''
                        }`
                    }
                </div>
                
                <!-- Fotos -->
                <div class="diag-card">
                    <h3>üì∏ Fotos Armazenadas</h3>
                    <div class="diag-stats">
                        <div class="diag-stat">
                            <div class="diag-stat-value">${report.photos.totalPhotos}</div>
                            <div class="diag-stat-label">Total de fotos</div>
                        </div>
                        <div class="diag-stat">
                            <div class="diag-stat-value">${report.photos.totalPhotoKeys}</div>
                            <div class="diag-stat-label">Componentes</div>
                        </div>
                        <div class="diag-stat">
                            <div class="diag-stat-value">${report.photos.totalSize}</div>
                            <div class="diag-stat-label">Espa√ßo usado</div>
                        </div>
                    </div>
                    ${report.photos.totalPhotos > 0 ? `
                        <div class="diag-photos-container">
                            ${report.photos.keys.map(key => {
                                const componentName = key.replace('photos_', '').split('_').slice(1).join(' > ');
                                const aeroName = key.replace('photos_', '').split('_')[0];
                                let photosHtml = '';
                                try {
                                    const photos = JSON.parse(localStorage.getItem(key) || '[]');
                                    if (photos.length > 0) {
                                        photosHtml = `
                                            <div class="diag-photo-group">
                                                <div class="diag-photo-title">
                                                    <strong>${aeroName}</strong> - ${componentName}
                                                    <span class="diag-photo-count">(${photos.length} foto${photos.length > 1 ? 's' : ''})</span>
                                                </div>
                                                <div class="diag-photo-thumbs">
                                                    ${photos.map((photo, idx) => `
                                                        <div class="diag-thumb" onclick="openPhotoModal('${photo.replace(/'/g, "\\'")}')">
                                                            <img src="${photo}" alt="Foto ${idx + 1}">
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        `;
                                    }
                                } catch(e) {}
                                return photosHtml;
                            }).join('')}
                        </div>
                    ` : `
                        <div class="diag-alert info" style="margin-top: 15px;">
                            Nenhuma foto salva ainda.
                        </div>
                    `}
                </div>
                
                <!-- Estrutura -->
                <div class="diag-card">
                    <h3>üèóÔ∏è Estrutura do Sistema</h3>
                    <div class="diag-stats">
                        <div class="diag-stat">
                            <div class="diag-stat-value">${report.estrutura.totalCategorias}</div>
                            <div class="diag-stat-label">Categorias</div>
                        </div>
                        <div class="diag-stat">
                            <div class="diag-stat-value">${report.estrutura.totalComponentes}</div>
                            <div class="diag-stat-label">Componentes</div>
                        </div>
                        <div class="diag-stat">
                            <div class="diag-stat-value">${report.estrutura.totalAerogeradores}</div>
                            <div class="diag-stat-label">Aerogeradores</div>
                        </div>
                    </div>
                </div>
                
                <!-- Recomenda√ß√µes -->
                ${report.recommendations.length > 0 ? `
                <div class="diag-card">
                    <h3>üí° Recomenda√ß√µes</h3>
                    ${report.recommendations.map(r => {
                        let alertClass = 'info';
                        if (r.startsWith('‚ùå')) alertClass = 'error';
                        else if (r.startsWith('‚ö†Ô∏è')) alertClass = 'warning';
                        return `<div class="diag-alert ${alertClass}">${r}</div>`;
                    }).join('')}
                </div>
                ` : ''}
                
                <!-- Detalhes por Aerogerador -->
                ${report.inspectionData.byAerogerador && Object.keys(report.inspectionData.byAerogerador).length > 0 ? `
                <div class="diag-card">
                    <h3>üìä Inspe√ß√µes por Aerogerador</h3>
                    <table class="diag-table">
                        <thead>
                            <tr>
                                <th>Aerogerador</th>
                                <th>Componentes</th>
                                <th>Verificados</th>
                                <th>Com Defeito</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(report.inspectionData.byAerogerador).map(([aero, info]) => {
                                const verificados = info.classifications['Verificado'] || 0;
                                const comDefeito = info.count - verificados;
                                return `<tr>
                                    <td><strong>${aero}</strong></td>
                                    <td>${info.count}</td>
                                    <td style="color: #28a745;">${verificados}</td>
                                    <td style="color: ${comDefeito > 0 ? '#dc3545' : '#666'};">${comDefeito}</td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}
            `;
            
            // Abrir modal
            openDiagnosticModal();
            
            console.log('Relat√≥rio de Diagn√≥stico:', report);
        }
        
        /**
         * Formata bytes para exibi√ß√£o leg√≠vel
         */
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // Iniciar aplica√ß√£o quando DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
